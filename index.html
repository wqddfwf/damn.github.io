<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <!-- PWA 必需标签 -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007AFF">

  <!-- iOS 额外支持 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="记账">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon.png">

  <!-- 安卓/通用 PWA 支持 -->
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- 添加Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  
  <!-- 添加SheetJS库用于Excel导出 -->
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  
  <!-- 添加Chart.js用于图表 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  
  <!-- 添加Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600&display=swap" rel="stylesheet">
  
  <title>每日记账</title>
  <style>
      :root {
          --primary-blue: #007AFF;
          --primary-red: #FF3B30;
          --primary-green: #34C759;
          --primary-orange: #FF9500;
          --system-gray-1: #F2F2F7;
          --system-gray-2: #E5E5EA;
          --system-gray-3: #D1D1D6;
          --system-gray-4: #8E8E93;
          --system-gray-5: #636366;
          --system-gray-6: #48484A;
          --white: #FFFFFF;
          --black: #000000;
      }
      
      body {
          font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
          background-color: var(--system-gray-1);
          color: var(--black);
          margin: 0;
          padding: 0;
          max-width: 100%;
          overflow-x: hidden;
          -webkit-tap-highlight-color: transparent;
          line-height: 1.5;
          padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      }
      
      .container {
          padding: 20px;
          max-width: 600px;
          margin: 0 auto;
          padding-bottom: 100px;
      }
      
      .header {
          font-size: 28px;
          font-weight: 600;
          margin-bottom: 24px;
          text-align: center;
          color: var(--black);
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      
      .logout-button, .details-button {
          background: none;
          border: none;
          cursor: pointer;
          padding: 8px;
          display: flex;
          align-items: center;
      }
      
      .logout-button:hover, .details-button:hover {
          background-color: var(--system-gray-2);
          border-radius: 50%;
      }

      /* 苹果风格登录界面 */
      .auth-card {
          background-color: rgba(255, 255, 255, 0.95);
          border-radius: 20px;
          padding: 32px 24px;
          margin: 40px 20px;
          box-shadow: 0 8px 30px rgba(0,0,0,0.12);
          max-width: 400px;
          margin-left: auto;
          margin-right: auto;
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
      }
      
      .auth-title {
          font-size: 28px;
          font-weight: 600;
          margin-bottom: 28px;
          text-align: center;
          color: var(--black);
          letter-spacing: -0.5px;
          background: linear-gradient(135deg, #007AFF, #5AC8FA);
          -webkit-background-clip: text;
          background-clip: text;
          -webkit-text-fill-color: transparent;
      }
      
      .auth-form {
          display: flex;
          flex-direction: column;
          gap: 20px;
      }
      
      .auth-input-group {
          position: relative;
      }
      
      .auth-input {
          padding: 16px;
          border: 1px solid rgba(0,0,0,0.05);
          border-radius: 12px;
          font-size: 16px;
          background-color: rgba(242, 242, 247, 0.6);
          transition: all 0.2s;
          width: 100%;
          box-sizing: border-box;
      }
      
      .auth-input:focus {
          outline: none;
          border-color: var(--primary-blue);
          background-color: rgba(242, 242, 247, 0.8);
          box-shadow: 0 0 0 2px rgba(0,122,255,0.1);
      }
      
      .auth-button {
          padding: 16px;
          border-radius: 12px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          border: none;
          transition: all 0.2s;
          width: 100%;
      }
      
      .login-button {
          background-color: var(--primary-blue);
          color: var(--white);
          margin-top: 16px;
          box-shadow: 0 4px 12px rgba(0,122,255,0.2);
      }
      
      .login-button:active {
          background-color: #0066CC;
          transform: scale(0.98);
          box-shadow: 0 2px 6px rgba(0,122,255,0.15);
      }
      
      .forgot-password {
          color: var(--primary-blue);
          font-size: 15px;
          text-align: center;
          margin-top: 20px;
          cursor: pointer;
          font-weight: 500;
      }
      
      .app-icon {
          width: 80px;
          height: 80px;
          margin: 0 auto 24px;
          background: linear-gradient(135deg, #007AFF, #5AC8FA);
          border-radius: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 8px 20px rgba(0,122,255,0.2);
      }
      
      /* 主应用内容 */
      .date-picker {
          margin-bottom: 20px;
          padding: 0;
          background: transparent;
          box-shadow: none;
          display: block;
          position: relative;
      }
      
      .ios-date-selector {
          background-color: rgba(255, 255, 255, 0.9);
          border-radius: 16px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          overflow: hidden;
          margin-bottom: 16px;
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
      }
      
      .date-display {
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 16px 20px; /* 增加水平内边距 */
          border-bottom: 1px solid rgba(0,0,0,0.03);
          position: relative;
          gap: 8px; /* 添加间距 */
          cursor: pointer; /* 表明可点击 */
          transition: background-color 0.2s;
      }
      
      .date-display:active {
          background-color: var(--system-gray-1);
      }
      
      .date-display-text {
          font-size: 22px; /* 增大字体 */
          font-weight: 600;
          color: var(--black);
          display: flex;
          align-items: center;
      }
      
      .date-display-text:after {
          content: '';
          display: inline-block;
          width: 10px;
          height: 10px;
          border-right: 2px solid var(--system-gray-4);
          border-bottom: 2px solid var(--system-gray-4);
          transform: rotate(45deg);
          margin-left: 8px;
          margin-top: -4px;
          transition: transform 0.2s;
      }
      
      .date-select-animation .date-display-text:after {
          transform: rotate(-135deg);
          margin-top: 4px;
      }
      
      .date-selector-controls {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 12px 16px;
      }
      
      .date-actions {
          display: flex;
          gap: 10px;
      }
      
      .date-action-button {
          background-color: rgba(242, 242, 247, 0.8);
          border: none;
          height: 36px;
          border-radius: 8px;
          font-size: 15px;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          color: var(--primary-blue);
          padding: 0 12px;
          transition: all 0.2s;
      }
      
      .date-action-button:active {
          background-color: rgba(0, 122, 255, 0.1);
          transform: scale(0.98);
      }
      
      .date-action-button svg {
          width: 16px;
          height: 16px;
      }
      
      .date-action-button#todayButton {
          background-color: var(--primary-blue);
          color: white;
      }
      
      .date-action-button#todayButton:active {
          background-color: #0066CC;
      }
      
      .hidden-date-input {
          position: absolute;
          top: 0;
          left: 0;
          width: 1px;
          height: 1px;
          opacity: 0;
          pointer-events: none;
      }
      
      /* 日期选择动画 */
      @keyframes date-selection-pulse {
          0% {
              background-color: rgba(0, 122, 255, 0.2);
          }
          100% {
              background-color: rgba(255, 255, 255, 0.9);
          }
      }
      
      .date-select-animation {
          animation: date-selection-pulse 0.6s ease;
      }
      
      .summary-card {
          background-color: var(--white);
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 20px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      }
      
      .summary-title {
          font-size: 17px;
          color: var(--system-gray-4);
          margin-bottom: 16px;
          text-align: center;
          font-weight: 500;
      }
      
      .summary-items {
          display: flex;
          justify-content: space-between;
          gap: 12px;
      }
      
      .summary-item {
          flex: 1;
          text-align: center;
          padding: 12px;
          border-radius: 8px;
          background-color: var(--system-gray-1);
      }
      
      .summary-item-title {
          font-size: 14px;
          color: var(--system-gray-4);
          margin-bottom: 6px;
      }
      
      .summary-item-value {
          font-size: 20px;
          font-weight: 600;
      }
      
      .records-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
      }
      
      .records-title {
          font-size: 17px;
          color: var(--system-gray-4);
          font-weight: 500;
      }
      
      .export-dropdown {
          position: relative;
          display: inline-block;
      }
      
      .export-button {
          padding: 8px 16px;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
          border: 1px solid var(--system-gray-2);
          background-color: var(--white);
          color: var(--primary-blue);
          transition: all 0.2s;
          display: flex;
          align-items: center;
          gap: 6px;
      }
      
      .export-button:hover {
          background-color: var(--system-gray-1);
      }
      
      .dropdown-content {
          display: none;
          position: absolute;
          right: 0;
          background-color: var(--white);
          min-width: 120px;
          box-shadow: 0 8px 16px rgba(0,0,0,0.1);
          border-radius: 8px;
          z-index: 1;
          overflow: hidden;
      }
      
      .dropdown-content a {
          color: var(--system-gray-6);
          padding: 12px 16px;
          text-decoration: none;
          display: block;
          font-size: 14px;
          transition: background-color 0.2s;
      }
      
      .dropdown-content a:hover {
          background-color: var(--system-gray-1);
      }
      
      .export-dropdown:hover .dropdown-content {
          display: block;
      }
      
      .records-list {
          background-color: var(--white);
          border-radius: 12px;
          overflow: hidden;
          margin-bottom: 20px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      }
      
      .record-item {
          padding: 16px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-bottom: 1px solid var(--system-gray-1);
      }
      
      .record-item:last-child {
          border-bottom: none;
      }
      
      .record-type {
          font-size: 16px;
          flex: 1;
      }
      
      .record-amount.income {
          color: var(--primary-green);
          font-weight: 500;
      }
      
      .record-amount.expense {
          color: var(--primary-red);
          font-weight: 500;
      }
      
      .no-records {
          text-align: center;
          color: var(--system-gray-4);
          padding: 24px;
          font-size: 16px;
      }
      
      /* 改进添加按钮样式 */
      .add-button {
          width: 60px;
          height: 60px;
          background: linear-gradient(135deg, var(--primary-blue), #0066CC);
          color: var(--white);
          border-radius: 30px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 28px;
          box-shadow: 0 4px 16px rgba(0,122,255,0.3);
          border: none;
          cursor: pointer;
          transition: all 0.25s cubic-bezier(0.25, 1, 0.5, 1);
      }
      
      .add-button:active {
          transform: scale(0.95);
          box-shadow: 0 2px 8px rgba(0,122,255,0.2);
      }
      
      /* iOS风格模态框 */
      .modal {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: rgba(0,0,0,0.4);
          backdrop-filter: blur(12px);
          -webkit-backdrop-filter: blur(12px);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 100;
          display: none;
          padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      }
      
      .modal-content {
          background-color: rgba(255, 255, 255, 0.96);
          width: calc(100% - 40px);
          max-width: 400px;
          border-radius: 20px;
          overflow: hidden;
          animation: modal-appear 0.3s cubic-bezier(0.25, 1, 0.5, 1);
          margin: auto;
          box-shadow: 0 8px 40px rgba(0,0,0,0.18);
      }
      
      .modal-header {
          padding: 18px 20px;
          font-size: 20px;
          font-weight: 600;
          border-bottom: 1px solid rgba(0,0,0,0.05);
          display: flex;
          justify-content: space-between;
          align-items: center;
          color: var(--black);
      }
      
      .modal-body {
          padding: 18px;  /* 减小内边距 */
      }
      
      .form-group {
          margin-bottom: 18px;  /* 减小底部边距 */
      }
      
      .form-group label {
          display: block;
          margin-bottom: 8px;  /* 减小底部边距 */
          color: var(--system-gray-5);
          font-size: 14px;  /* 减小字体大小 */
          font-weight: 500;
      }
      
      .form-group input {
          width: 90%;  /* 缩小宽度从100%到90%，适配苹果手机 */
          padding: 10px;  /* 减小内边距 */
          border: 1px solid rgba(0,0,0,0.05);
          border-radius: 10px;  /* 减小圆角 */
          font-size: 16px;  /* 减小字体大小 */
          background-color: rgba(242, 242, 247, 0.6);
          transition: all 0.2s;
          height: 40px;  /* 减小高度 */
      }
      
      .form-group input:focus {
          outline: none;
          border-color: var(--primary-blue);
          background-color: rgba(242, 242, 247, 0.8);
          box-shadow: 0 0 0 2px rgba(0,122,255,0.1);
      }
      
      .type-options {
          display: flex;
          flex-wrap: wrap;
          gap: 8px;  /* 减小间距 */
      }
      
      .type-option {
          padding: 10px 12px;  /* 减小内边距 */
          border: 1px solid rgba(0,0,0,0.05);
          border-radius: 10px;  /* 减小圆角 */
          font-size: 14px;  /* 减小字体大小 */
          cursor: pointer;
          background-color: rgba(242, 242, 247, 0.6);
          transition: all 0.2s;
      }
      
      .type-option.selected {
          background-color: var(--primary-blue);
          color: var(--white);
          border-color: var(--primary-blue);
          font-weight: 500;
          box-shadow: 0 2px 8px rgba(0,122,255,0.2);
      }
      
      .type-option:active {
          transform: scale(0.98);
          background-color: rgba(242, 242, 247, 0.8);
      }
      
      .modal-footer {
          display: flex;
          justify-content: flex-end;
          padding: 16px 20px 20px;
          border-top: 1px solid rgba(0,0,0,0.03);
          gap: 12px;
      }
      
      .btn {
          padding: 14px 22px;
          border-radius: 12px;
          font-size: 16px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.2s;
          border: none;
      }
      
      .btn-cancel {
          background-color: rgba(242, 242, 247, 0.8);
          color: var(--system-gray-6);
      }
      
      .btn-cancel:active {
          background-color: rgba(242, 242, 247, 0.9);
          transform: scale(0.98);
      }
      
      .btn-save {
          background-color: var(--primary-blue);
          color: var(--white);
          box-shadow: 0 2px 8px rgba(0,122,255,0.2);
      }
      
      .btn-save:active {
          background-color: #0066CC;
          transform: scale(0.98);
          box-shadow: 0 1px 4px rgba(0,122,255,0.15);
      }
      
      /* 详细数据模态框改进 */
      .details-modal-content {
          max-width: 600px;
          width: calc(100% - 32px);
          max-height: 90vh; /* 略微增加高度 */
          overflow-y: auto;
          border-radius: 20px;
          background-color: rgba(255, 255, 255, 0.98);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          box-shadow: 0 10px 40px rgba(0,0,0,0.18);
          -webkit-overflow-scrolling: touch; /* iOS流畅滚动 */
      }
      
      .summary-stats {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 8px;  /* 减小间距 */
          margin: 16px 0;  /* 减小上下边距 */
          padding: 0 16px;  /* 减小左右内边距 */
      }
      
      .stat-card {
          flex: 1;
          padding: 14px 10px;  /* 减小内边距 */
          background-color: rgba(250, 250, 250, 0.8);
          border-radius: 14px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.03);
          display: flex;
          flex-direction: column;
          align-items: center;
          backdrop-filter: blur(5px);
          -webkit-backdrop-filter: blur(5px);
      }
      
      .stat-label {
          font-size: 13px;  /* 减小字体大小 */
          color: var(--system-gray-4);
          margin-bottom: 4px;  /* 减小底部边距 */
          font-weight: 500;
      }
      
      .stat-value {
          font-size: 22px;  /* 减小字体大小 */
          font-weight: 600;
      }
      
      .stat-value.income {
          color: var(--primary-green);
      }
      
      .stat-value.expense {
          color: var(--primary-red);
      }
      
      .stat-value.profit {
          color: var(--primary-blue);
      }
      
      .date-range-selector {
          margin: 20px 16px;
          padding: 0;
          background: transparent;
          border: none;
          box-shadow: none;
      }
      
      .date-range-title {
          font-size: 15px;
          font-weight: 600;
          color: var(--system-gray-5);
          margin-bottom: 12px;
          letter-spacing: -0.2px;
      }
      
      .date-range-buttons {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 10px;
          margin-bottom: 22px;
      }
      
      .range-preset-button {
          padding: 12px 0;
          background-color: transparent;
          border: 1px solid var(--system-gray-3);
          border-radius: 10px;
          font-size: 14px;
          font-weight: 500;
          color: var(--black);
          cursor: pointer;
          transition: all 0.2s;
          text-align: center;
      }
      
      .range-preset-button:active,
      .range-preset-button.active {
          background-color: var(--primary-blue);
          color: var(--white);
          transform: none;
          border-color: var(--primary-blue);
      }
      
      .custom-range-inputs {
          margin-bottom: 22px;
          position: relative;
      }
      
      .date-input-wrapper {
          background-color: var(--white);
          border: 1px solid var(--system-gray-3);
          border-radius: 12px;
          padding: 10px 12px 8px;
          margin-bottom: 10px;
          position: relative;
      }
      
      .date-input-label {
          position: static;
          display: block;
          font-size: 12px;
          color: var(--system-gray-4);
          margin-bottom: 4px;
          background: transparent;
          padding: 0;
      }
      
      .date-range-input {
          width: 100%;
          padding: 0;
          border: none;
          font-size: 15px;
          font-weight: 450;
          background-color: transparent;
          color: var(--black);
          -webkit-appearance: none;
          appearance: none;
      }
      
      .date-range-input:focus {
          outline: none;
          box-shadow: none;
          border: none;
      }
      
      .apply-dates-button {
          width: 100%;
          background-color: var(--primary-blue);
          color: var(--white);
          padding: 14px;
          border-radius: 12px;
          font-size: 16px;
          font-weight: 500;
          cursor: pointer;
          border: none;
          transition: opacity 0.2s;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: none;
      }
      
      .apply-dates-button:active {
          opacity: 0.9;
          transform: none;
      }
      
      /* 优化图表容器 */
      .chart-container {
          margin: 0 20px 24px;
          background-color: rgba(250, 250, 250, 0.8);
          border-radius: 16px;
          padding: 16px;
          box-shadow: 0 1px 5px rgba(0,0,0,0.03);
          backdrop-filter: blur(5px);
          -webkit-backdrop-filter: blur(5px);
      }
      
      .chart-title {
          font-size: 16px;
          font-weight: 600;
          color: var(--system-gray-5);
          margin-bottom: 16px;
          text-align: center;
      }
      
      .chart-wrapper {
          height: 280px; /* 增加图表高度，方便手机查看和点击 */
          width: 100%;
          position: relative; /* 确保图表正确定位 */
          touch-action: pan-y; /* 优化触摸体验 */
      }
      
      /* 金额输入优化 */
      .form-group input[type="number"] {
          width: 90%;  /* 缩小宽度从100%到90%，适配苹果手机 */
          padding: 10px;  /* 减小内边距 */
          border: 1px solid rgba(0,0,0,0.05);
          border-radius: 10px;  /* 减小圆角 */
          font-size: 16px;  /* 减小字体大小 */
          background-color: rgba(242, 242, 247, 0.6);
          transition: all 0.2s;
          -webkit-appearance: none; /* 移除iOS默认样式 */
          appearance: none;
          box-shadow: none;
          height: 40px;  /* 减小高度 */
      }
      
      .form-group input[type="number"]:focus {
          outline: none;
          border-color: var(--primary-blue);
          background-color: rgba(242, 242, 247, 0.8);
          box-shadow: 0 0 0 2px rgba(0,122,255,0.1);
      }
      
      /* 去除数字输入框的上下箭头 */
      .form-group input[type="number"]::-webkit-inner-spin-button,
      .form-group input[type="number"]::-webkit-outer-spin-button {
          -webkit-appearance: none;
          margin: 0;
      }
      
      /* 添加图表触摸优化样式 */
      .chart-touch-overlay {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          z-index: 1;
          pointer-events: none;
      }
      
      /* 图表点样式调整，增大交互区域 */
      @media (max-width: 768px) {
          .chart-wrapper {
              height: 240px; /* 手机端稍微减小高度 */
          }
      }
      
      /* 优化关闭按钮 */
      .ios-header-button {
          background-color: rgba(240, 240, 245, 0.6);
          border: none;
          padding: 8px 16px;
          font-size: 15px;
          font-weight: 500;
          color: var(--primary-blue);
          cursor: pointer;
          transition: all 0.2s;
          border-radius: 12px;
      }
      
      .ios-header-button:active {
          background-color: rgba(0,122,255,0.1);
          transform: scale(0.98);
      }
      
      /* 密码重置模态框 */
      .reset-modal-content {
          background-color: var(--white);
          width: calc(100% - 40px);
          max-width: 400px;
          border-radius: 12px;
          overflow: hidden;
          margin: auto;
      }
      
      .reset-instructions {
          font-size: 14px;
          color: var(--system-gray-4);
          margin-top: 8px;
      }
      
      /* 响应式调整 */
      @media (max-width: 400px) {
          .summary-items {
              flex-direction: column;
              gap: 12px;
          }
          .range-picker {
              flex-direction: column;
          }
      }

      /* 添加离线通知样式 */
      .offline-notice {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          background-color: rgba(255, 149, 0, 0.95);
          color: white;
          text-align: center;
          padding: 10px 20px;
          font-size: 14px;
          font-weight: 500;
          z-index: 1000;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
      }

      .offline-notice.show {
          display: block;
          animation: slideDown 0.3s forwards;
      }

      @keyframes slideDown {
          from {
              transform: translateY(-100%);
          }
          to {
              transform: translateY(0);
          }
      }

      /* 修改详细数据按钮样式 */
      .details-button {
          background: none;
          border: none;
          cursor: pointer;
          padding: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          color: var(--system-gray-6);
          transition: all 0.2s;
          border-radius: 50%;
          width: 38px;
          height: 38px;
      }

      .details-button:active {
          background-color: rgba(0,0,0,0.05);
          transform: scale(0.95);
      }

      .date-button.date-selected {
          animation: date-pulse 0.5s ease;
      }

      @keyframes date-pulse {
          0% {
              background-color: rgba(0, 122, 255, 0.2);
              box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.4);
          }
          70% {
              background-color: rgba(0, 122, 255, 0.1);
              box-shadow: 0 0 0 1px rgba(0, 122, 255, 0.2);
          }
          100% {
              background-color: rgba(255, 255, 255, 0.9);
              box-shadow: 0 1px 5px rgba(0,0,0,0.03);
          }
      }

      /* iOS风格加载指示器 */
      .loader {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: rgba(255, 255, 255, 0.96);
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
          z-index: 9999;
          display: none;
          justify-content: center;
          align-items: center;
      }

      .loader-content {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 20px;
      }

      .loader-spinner {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          border: 3px solid rgba(0, 122, 255, 0.2);
          border-top-color: var(--primary-blue);
          animation: spin 1s infinite linear;
      }

      .loader-text {
          color: var(--system-gray-5);
          font-size: 16px;
          font-weight: 500;
      }

      @keyframes spin {
          to {
              transform: rotate(360deg);
          }
      }

      /* 日期选择效果 */
      .date-selected {
          animation: date-selected-pulse 0.5s ease;
      }

      @keyframes date-selected-pulse {
          0% {
              background-color: rgba(0, 122, 255, 0.2);
          }
          70% {
              background-color: rgba(0, 122, 255, 0.1);
          }
          100% {
              background-color: transparent;
          }
      }
      
      /* 苹果风格日历选择器样式 */
      .calendar-modal-content {
          background-color: rgba(250, 250, 250, 0.98);
          width: calc(100% - 40px);
          max-width: 340px;
          border-radius: 20px;
          overflow: hidden;
          animation: modal-appear 0.3s cubic-bezier(0.25, 1, 0.5, 1);
          margin: auto;
          box-shadow: 0 8px 40px rgba(0,0,0,0.18);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
      }
      
      .calendar-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 18px 16px;
          border-bottom: 1px solid rgba(0,0,0,0.05);
      }
      
      .current-month-year {
          font-size: 18px;
          font-weight: 600;
          color: var(--black);
      }
      
      .calendar-nav-btn {
          background: none;
          border: none;
          cursor: pointer;
          width: 40px;
          height: 40px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
          color: var(--primary-blue);
          transition: background-color 0.2s;
      }
      
      .calendar-nav-btn:active {
          background-color: rgba(0,0,0,0.1);
      }
      
      .weekday-header {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          padding: 12px 16px 0;
      }
      
      .weekday {
          font-size: 13px;
          color: var(--system-gray-4);
          text-align: center;
          font-weight: 500;
          padding: 8px 0;
      }
      
      .calendar-days {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          padding: 0 16px 16px;
          gap: 4px;
      }
      
      .calendar-day {
          aspect-ratio: 1;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 16px;
          cursor: pointer;
          border-radius: 50%;
          position: relative;
          color: var(--black);
      }
      
      .calendar-day:active {
          background-color: rgba(0,0,0,0.1);
      }
      
      .calendar-day.other-month {
          color: var(--system-gray-3);
      }
      
      .calendar-day.today:after {
          content: '';
          position: absolute;
          bottom: 4px;
          left: 50%;
          transform: translateX(-50%);
          width: 4px;
          height: 4px;
          background-color: var(--primary-blue);
          border-radius: 50%;
      }
      
      .calendar-day.selected {
          background-color: var(--primary-blue);
          color: white;
          font-weight: 500;
          box-shadow: 0 2px 6px rgba(0,122,255,0.3);
      }
      
      .calendar-day.selected:after {
          display: none;
      }
      
      .calendar-footer {
          display: flex;
          justify-content: space-between;
          padding: 12px 16px;
          border-top: 1px solid rgba(0,0,0,0.05);
      }
      
      .calendar-today-btn {
          background-color: transparent;
          border: none;
          color: var(--primary-blue);
          font-size: 16px;
          font-weight: 500;
          cursor: pointer;
          padding: 8px 16px;
          border-radius: 12px;
      }
      
      .calendar-today-btn:active {
          background-color: rgba(0,122,255,0.1);
      }
      
      .calendar-close-btn {
          background-color: var(--system-gray-1);
          border: none;
          color: var(--system-gray-6);
          font-size: 16px;
          font-weight: 500;
          cursor: pointer;
          padding: 8px 16px;
          border-radius: 12px;
      }
      
      .calendar-close-btn:active {
          background-color: var(--system-gray-2);
      }
      
      /* 日历动画效果 */
      .slide-left {
          animation: slideLeft 0.3s forwards;
      }
      
      .slide-right {
          animation: slideRight 0.3s forwards;
      }
      
      @keyframes slideLeft {
          from {
              transform: translateX(20px);
              opacity: 0;
          }
          to {
              transform: translateX(0);
              opacity: 1;
          }
      }
      
      @keyframes slideRight {
          from {
              transform: translateX(-20px);
              opacity: 0;
          }
          to {
              transform: translateX(0);
              opacity: 1;
          }
      }
      
      @keyframes modal-appear {
          from {
              transform: translateY(20px);
              opacity: 0;
          }
          to {
              transform: translateY(0);
              opacity: 1;
          }
      }

      /* 增加响应式设计和优化 */
      @media (max-width: 375px) {
          .date-range-title {
              font-size: 14px;
              margin-bottom: 10px;
          }
          
          .range-preset-button {
              font-size: 13px;
              padding: 10px 0;
          }
          
          .date-range-buttons {
              gap: 8px;
              margin-bottom: 18px;
          }
          
          .date-input-wrapper {
              padding: 8px 10px 6px;
          }
          
          .date-input-label {
              font-size: 11px;
          }
          
          .date-range-input {
              font-size: 14px;
          }
          
          .apply-dates-button {
              padding: 12px;
              font-size: 15px;
          }
          
          .stat-value {
              font-size: 20px;
          }
          
          .stat-label {
              font-size: 12px;
          }
          
          .chart-title {
              font-size: 14px;
          }
          
          .chart-wrapper {
              height: 220px;
          }
          
          .modal-header {
              padding: 12px 16px;
          }
      }

      /* 增加横屏模式优化 */
      @media (orientation: landscape) and (max-height: 500px) {
          .details-modal-content {
              max-height: 95vh;
              display: flex;
              flex-direction: column;
          }
          
          .modal-body {
              overflow-y: auto;
              display: grid;
              grid-template-columns: 1fr 1fr;
              grid-gap: 10px;
          }
          
          .summary-stats {
              grid-column: 1 / 3;
          }
          
          .date-range-selector {
              grid-column: 1 / 3;
          }
          
          .chart-container {
              margin: 0 0 15px;
          }
          
          .chart-wrapper {
              height: 200px;
          }
      }

      /* 触控优化 */
      .range-preset-button, .apply-dates-button, .date-input-wrapper {
          min-height: 44px; /* 最小触控区域高度 */
      }

      input, button {
          touch-action: manipulation; /* 防止延迟点击 */
      }

      @media (pointer: coarse) {
          /* 针对触摸设备的样式 */
          .range-preset-button, .apply-dates-button {
              padding: 12px 0;
          }
          
          .type-option {
              padding: 14px;
          }
      }

      /* 新增记录列表和分页样式 */
      .records-list-container {
          margin: 0 16px 24px;
          background-color: rgba(250, 250, 250, 0.8);
          border-radius: 16px;
          padding: 16px;
          box-shadow: 0 1px 5px rgba(0,0,0,0.03);
          backdrop-filter: blur(5px);
          -webkit-backdrop-filter: blur(5px);
      }

      .records-list-title {
          font-size: 16px;
          font-weight: 600;
          color: var(--system-gray-5);
          margin-bottom: 16px;
          text-align: center;
      }

      .details-records-list {
          margin-bottom: 16px;
      }

      .date-header {
          padding: 8px 0;
          font-size: 14px;
          font-weight: 600;
          color: var(--system-gray-5);
          border-bottom: 1px solid var(--system-gray-2);
          margin-bottom: 8px;
      }

      .detail-record-item {
          display: flex;
          justify-content: space-between;
          padding: 10px;
          border-bottom: 1px solid var(--system-gray-2);
          font-size: 15px;
      }

      .detail-record-item:last-child {
          border-bottom: none;
      }

      .record-type {
          font-weight: 500;
      }

      .record-amount {
          font-weight: 600;
      }

      .record-type.income, .record-amount.income {
          color: var(--primary-green);
      }

      .record-type.expense, .record-amount.expense {
          color: var(--primary-red);
      }

      .pagination-controls {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 10px 0;
      }

      .pagination-button {
          background-color: var(--white);
          border: 1px solid var(--system-gray-3);
          border-radius: 8px;
          padding: 8px 12px;
          font-size: 14px;
          font-weight: 500;
          color: var(--primary-blue);
          cursor: pointer;
      }

      .pagination-button:disabled {
          opacity: 0.5;
          cursor: not-allowed;
      }

      .pagination-info {
          font-size: 14px;
          color: var(--system-gray-5);
      }

      .no-records {
          text-align: center;
          color: var(--system-gray-4);
          padding: 20px;
          font-size: 15px;
      }
  </style>
</head>
<body>
    <!-- 加载指示器 -->
    <div class="loader" id="loader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <p class="loader-text" id="loaderText">数据加载中...</p>
        </div>
    </div>
    
    <!-- 离线提示 -->
    <div class="offline-notice" id="offlineNotice">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
            <path d="M12 16V16.01M12 8V12M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        您当前处于离线状态，可以查看最近数据
    </div>
    
    <div class="container">
        <!-- 认证部分 -->
        <div id="authSection">
            <div class="auth-card">
                <div class="app-icon">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 6.5H10M3 12H16M3 17.5H21" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h2 class="auth-title">每日记账</h2>
                <div id="loginForm" class="auth-form">
                    <div class="auth-input-group">
                        <input type="email" id="email" class="auth-input" placeholder="电子邮箱">
                    </div>
                    <div class="auth-input-group">
                        <input type="password" id="password" class="auth-input" placeholder="密码">
                    </div>
                    <button id="loginButton" class="auth-button login-button">登录</button>
                    <div class="forgot-password" id="forgotPassword">忘记密码？</div>
                    <div id="authError" class="error-message" style="color: var(--primary-red); text-align: center; font-size: 14px; margin-top: 12px;"></div>
                </div>
            </div>
        </div>
        
        <!-- 主应用内容 (默认隐藏，登录后显示) -->
        <div id="appContent" style="display: none;">
            <div class="header">
                <button class="details-button" id="detailsButton" title="详细数据">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 7H21M3 12H21M3 17H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
                <span>每日记账</span>
                <button class="logout-button" id="logoutButton" title="退出登录">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9M16 17L21 12M21 12L16 7M21 12H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            
            <div class="date-picker">
                <div class="ios-date-selector">
                    <div class="date-display">
                        <div class="date-display-text" id="dateDisplay"></div>
                    </div>
                    <div class="date-selector-controls">
                        <div class="date-actions">
                            <button class="date-action-button" id="prevDayButton" title="前一天">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M15 6L9 12L15 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                            <button class="date-action-button" id="todayButton">今天</button>
                            <button class="date-action-button" id="nextDayButton" title="后一天">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M9 6L15 12L9 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                        <button class="date-action-button" id="dateButton">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--primary-blue);">
                                <path d="M8 7V3M16 7V3M3 11H21M5 5H19C20.1046 5 21 5.89543 21 7V19C21 20.1046 20.1046 21 19 21H5C3.89543 21 3 20.1046 3 19V7C3 5.89543 3.89543 5 5 5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <input type="date" id="datePicker" class="hidden-date-input">
            </div>
            
            <div class="summary-card">
                <div class="summary-title">概览</div>
                <div class="summary-items">
                    <div class="summary-item">
                        <div class="summary-item-title">收入</div>
                        <div class="summary-item-value" id="incomeTotal">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-item-title">费用</div>
                        <div class="summary-item-value" id="expenseTotal">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-item-title">利润</div>
                        <div class="summary-item-value" id="profitTotal">0.00</div>
                    </div>
                </div>
            </div>
            
            <!-- 添加记录按钮居中放置在概况下方 -->
            <div style="display: flex; justify-content: center; margin: 20px 0;">
                <button class="add-button" id="addButton" style="position: static; box-shadow: 0 4px 16px rgba(0,122,255,0.3);">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 6V12M12 12V18M12 12H18M12 12H6" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            
            <div class="records-header">
                <div class="records-title">记录</div>
                <div class="export-dropdown">
                    <button class="export-button">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 3V16M12 16L16 12M12 16L8 12M6 20H18C19.1046 20 20 19.1046 20 18V6C20 4.89543 19.1046 4 18 4H6C4.89543 4 4 4.89543 4 6V18C4 19.1046 4.89543 20 6 20Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        导出
                    </button>
                    <div class="dropdown-content">
                        <a href="#" id="exportCsv">导出为CSV</a>
                        <a href="#" id="exportExcel">导出为Excel</a>
                    </div>
                </div>
            </div>
            <div class="records-list" id="recordsList">
                <div class="no-records">暂无记录</div>
            </div>
            
            <!-- 添加记录模态框 -->
            <div class="modal" id="addModal">
                <div class="modal-content">
                    <div class="modal-header">添加记录</div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="amount">金额</label>
                            <input type="number" id="amount" placeholder="输入金额" min="0" step="0.01" inputmode="decimal" pattern="[0-9]*[.]?[0-9]*">
                        </div>
                        <div class="form-group">
                            <label>类型</label>
                            <div class="type-options" id="typeOptions">
                                <div class="type-option" data-type="收入-吃喝岭师">收入-吃喝岭师</div>
                                <div class="type-option" data-type="收入-24个半">收入-24个半</div>
                                <div class="type-option" data-type="收入-个人预约">收入-个人预约</div>
                                <div class="type-option" data-type="费用-食材">费用-食材</div>
                                <div class="type-option" data-type="费用-交通">费用-交通</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-cancel" id="cancelBtn">取消</button>
                        <button class="btn btn-save" id="saveBtn">保存</button>
                    </div>
                </div>
            </div>
            
            <!-- 详细数据模态框 -->
            <div class="modal" id="detailsModal">
                <div class="details-modal-content">
                    <div class="modal-header">
                        <span>详细数据</span>
                        <button class="ios-header-button" id="detailsCloseBtn">关闭</button>
                    </div>
                    <div class="modal-body">
                        <div class="summary-stats">
                            <div class="stat-card">
                                <div class="stat-label">总收入</div>
                                <div class="stat-value income" id="totalIncome">0.00</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">总费用</div>
                                <div class="stat-value expense" id="totalExpense">0.00</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">总利润</div>
                                <div class="stat-value profit" id="totalProfit">0.00</div>
                            </div>
                        </div>
                        
                        <div class="date-range-selector">
                            <div class="date-range-title">选择时间范围</div>
                            <div class="date-range-buttons">
                                <button class="range-preset-button" data-days="7">最近7天</button>
                                <button class="range-preset-button" data-days="30">最近30天</button>
                                <button class="range-preset-button" data-days="90">最近90天</button>
                                <button class="range-preset-button" data-range="month">本月</button>
                                <button class="range-preset-button" data-range="last-month">上月</button>
                                <button class="range-preset-button" data-range="year">今年</button>
                            </div>
                            <div class="custom-range-inputs">
                                <div class="date-input-wrapper">
                                    <span class="date-input-label">开始日期</span>
                                    <input type="date" id="startDate" class="date-range-input" placeholder="开始日期">
                                </div>
                                <div class="date-input-wrapper">
                                    <span class="date-input-label">结束日期</span>
                                    <input type="date" id="endDate" class="date-range-input" placeholder="结束日期">
                                </div>
                            </div>
                            <button id="applyDatesBtn" class="apply-dates-button">应用</button>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">利润趋势</div>
                            <div class="chart-wrapper">
                                <canvas id="profitChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">收入趋势</div>
                            <div class="chart-wrapper">
                                <canvas id="incomeChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">费用趋势</div>
                            <div class="chart-wrapper">
                                <canvas id="expenseChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="records-list-container">
                            <div class="records-list-title">详细记录</div>
                            <div id="detailsRecordsList" class="details-records-list">
                                <!-- 记录将通过JavaScript动态加载 -->
                            </div>
                            <div id="paginationControls" class="pagination-controls">
                                <button id="prevPage" class="pagination-button" onclick="goToPrevPage()">上一页</button>
                                <div class="pagination-info">
                                    <span id="currentPage">1</span> / <span id="totalPages">1</span>
                                </div>
                                <button id="nextPage" class="pagination-button" onclick="goToNextPage()">下一页</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 密码重置模态框 -->
    <div class="modal" id="resetModal">
        <div class="reset-modal-content">
            <div class="modal-header">重置密码</div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="resetEmail">电子邮箱</label>
                    <input type="email" id="resetEmail" placeholder="输入您的注册邮箱">
                    <p class="reset-instructions">我们将发送密码重置链接到您的邮箱</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" id="resetCancelBtn">取消</button>
                <button class="btn btn-save" id="resetSubmitBtn">发送</button>
            </div>
        </div>
    </div>
    
    <!-- 苹果风格日历选择器模态框 -->
    <div class="modal" id="calendarModal">
        <div class="calendar-modal-content">
            <div class="calendar-header">
                <button id="prevMonthBtn" class="calendar-nav-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 6L9 12L15 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <div id="currentMonthYear" class="current-month-year">2023年4月</div>
                <button id="nextMonthBtn" class="calendar-nav-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 6L15 12L9 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            <div class="weekday-header">
                <div class="weekday">日</div>
                <div class="weekday">一</div>
                <div class="weekday">二</div>
                <div class="weekday">三</div>
                <div class="weekday">四</div>
                <div class="weekday">五</div>
                <div class="weekday">六</div>
            </div>
            <div id="calendarDays" class="calendar-days">
                <!-- 日历日期会通过JavaScript动态生成 -->
            </div>
            <div class="calendar-footer">
                <button id="todayCalendarBtn" class="calendar-today-btn">今天</button>
                <button id="closeCalendarBtn" class="calendar-close-btn">关闭</button>
            </div>
        </div>
    </div>

    <script>
        // 数据结构
        class Record {
            constructor(amount, type, date) {
                this.id = Date.now().toString();
                this.amount = parseFloat(amount);
                this.type = type;
                this.date = date;
            }
        }

        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDYY_Cex21vcQGR9beUvOniHxNeRqbpr6k",
            authDomain: "jizhang-e867a.firebaseapp.com",
            databaseURL: "https://jizhang-e867a-default-rtdb.firebaseio.com",
            projectId: "jizhang-e867a",
            storageBucket: "jizhang-e867a.appspot.com",
            messagingSenderId: "879272417495",
            appId: "1:879272417495:web:11ff018db63c50c3ccf892",
            measurementId: "G-4R1MKP7G6S"
        };

        // 初始化Firebase - 添加性能优化选项
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // 启用离线持久化和性能优化
        database.goOnline();
        
        // 设置 FirebaseAuth 持久性为 LOCAL，减少需要重复登录次数
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        
        // 配置Firebase数据库缓存大小，提高加载速度
        firebase.database().ref('.info/connected').on('value', (snap) => {
            if (snap.val() === true) {
                // 当连接上时，设置缓存大小为10MB，提高性能并减少网络请求
                firebase.database().goOnline();
                database.ref().keepSynced(true);
            }
        });
        
        // 应用状态
        let records = [];
        let selectedDate = new Date().toISOString().split('T')[0];
        let currentUser = null;
        let isOnline = navigator.onLine;
        let selectedType = null;
        let profitChart, incomeChart, expenseChart;

        // 数据缓存系统
        const dataCache = {
            records: {},         // 按日期缓存记录
            statistics: {},      // 按日期范围缓存统计数据
            lastUpdated: {},     // 跟踪缓存上次更新时间
            
            // 获取缓存记录
            getRecords(date) {
                return this.records[date] || null;
            },
            
            // 存储记录到缓存
            setRecords(date, data) {
                this.records[date] = data;
                this.lastUpdated[`record_${date}`] = Date.now();
                
                // 将缓存保存到localStorage，使用异步处理避免阻塞UI
                setTimeout(() => {
                    try {
                        localStorage.setItem('jizhang_records_cache', JSON.stringify(this.records));
                        localStorage.setItem('jizhang_cache_timestamps', JSON.stringify(this.lastUpdated));
                    } catch (e) {
                        console.warn('缓存存储失败:', e);
                        // 如果存储空间不足，清理旧数据
                        this.cleanupOldData();
                    }
                }, 0);
            },
            
            // 获取缓存统计数据
            getStats(rangeKey) {
                return this.statistics[rangeKey] || null;
            },
            
            // 存储统计数据到缓存
            setStats(rangeKey, data) {
                this.statistics[rangeKey] = data;
                this.lastUpdated[`stats_${rangeKey}`] = Date.now();
                
                // 将缓存保存到localStorage，使用异步处理避免阻塞UI
                setTimeout(() => {
                    try {
                        localStorage.setItem('jizhang_stats_cache', JSON.stringify(this.statistics));
                        localStorage.setItem('jizhang_cache_timestamps', JSON.stringify(this.lastUpdated));
                    } catch (e) {
                        console.warn('缓存存储失败:', e);
                        // 如果存储空间不足，清理旧数据
                        this.cleanupOldData();
                    }
                }, 0);
            },
            
            // 判断缓存是否过期 (24小时)
            isExpired(key) {
                const timestamp = this.lastUpdated[key];
                if (!timestamp) return true;
                
                const now = Date.now();
                const ONE_DAY = 24 * 60 * 60 * 1000;
                return (now - timestamp) > ONE_DAY;
            },
            
            // 加载缓存
            loadFromStorage() {
                try {
                    const recordsCache = localStorage.getItem('jizhang_records_cache');
                    const statsCache = localStorage.getItem('jizhang_stats_cache');
                    const timestamps = localStorage.getItem('jizhang_cache_timestamps');
                    
                    if (recordsCache) this.records = JSON.parse(recordsCache);
                    if (statsCache) this.statistics = JSON.parse(statsCache);
                    if (timestamps) this.lastUpdated = JSON.parse(timestamps);
                } catch (e) {
                    console.warn('加载缓存失败:', e);
                    // 缓存损坏时清除
                    this.clear();
                }
            },
            
            // 清除缓存
            clear() {
                this.records = {};
                this.statistics = {};
                this.lastUpdated = {};
                
                try {
                    localStorage.removeItem('jizhang_records_cache');
                    localStorage.removeItem('jizhang_stats_cache');
                    localStorage.removeItem('jizhang_cache_timestamps');
                } catch (e) {
                    console.warn('清除缓存失败:', e);
                }
            },
            
            // 清理旧数据以节省空间
            cleanupOldData() {
                const now = Date.now();
                const ONE_WEEK = 7 * 24 * 60 * 60 * 1000;
                
                // 清理超过一周的缓存数据
                for (const key in this.lastUpdated) {
                    if ((now - this.lastUpdated[key]) > ONE_WEEK) {
                        if (key.startsWith('record_')) {
                            const date = key.replace('record_', '');
                            delete this.records[date];
                        } else if (key.startsWith('stats_')) {
                            const rangeKey = key.replace('stats_', '');
                            delete this.statistics[rangeKey];
                        }
                        delete this.lastUpdated[key];
                    }
                }
                
                // 重新尝试保存
                try {
                    localStorage.setItem('jizhang_records_cache', JSON.stringify(this.records));
                    localStorage.setItem('jizhang_stats_cache', JSON.stringify(this.statistics));
                    localStorage.setItem('jizhang_cache_timestamps', JSON.stringify(this.lastUpdated));
                } catch (e) {
                    console.warn('即使清理后仍然无法保存缓存:', e);
                }
            }
        };
        
        // 初始化时加载缓存
        dataCache.loadFromStorage();
        
        // 数据加载和图表更新函数
        function loadRecordsForDateRange(startDate, endDate, callback) {
            if (!currentUser) return;
            
            const rangeKey = `${startDate}_${endDate}`;
            const cachedStats = dataCache.getStats(rangeKey);
            
            if (cachedStats && !dataCache.isExpired(`stats_${rangeKey}`)) {
                // 使用缓存数据更新图表
                updateChartsWithData(cachedStats);
                if (callback) callback(cachedStats);
                return;
            }
            
            // 使用Firebase查询限制记录数量
            showLoader('正在加载数据...');
            const recordsRef = database.ref(`users/${currentUser.uid}/records`);
            
            recordsRef.orderByChild('date')
                .startAt(startDate)
                .endAt(endDate)
                .limitToLast(500) // 限制加载记录数量
                .once('value')
                .then(snapshot => {
                    hideLoader();
                    const data = snapshot.val() || {};
                    
                    // 预处理和聚合数据
                    const processedData = processDataForCharts(data, startDate, endDate);
                    
                    // 缓存处理后的数据
                    dataCache.setStats(rangeKey, processedData);
                    
                    // 更新图表
                    updateChartsWithData(processedData);
                    
                    if (callback) callback(processedData);
                })
                .catch(error => {
                    hideLoader();
                    console.error('加载数据失败:', error);
                    alert('加载数据失败，请检查网络连接。');
                });
        }
        
        // 数据预处理和聚合
        function processDataForCharts(data, startDate, endDate) {
            const records = Object.values(data || {});
            
            // 按日期分组汇总数据
            const dailyData = {};
            let totalIncome = 0;
            let totalExpense = 0;
            
            // 创建日期范围内的所有日期
            let currentDate = new Date(startDate);
            const endDateObj = new Date(endDate);
            while (currentDate <= endDateObj) {
                const dateString = currentDate.toISOString().split('T')[0];
                dailyData[dateString] = { income: 0, expense: 0, profit: 0 };
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // 汇总数据
            records.forEach(record => {
                const date = record.date;
                const amount = parseFloat(record.amount);
                
                if (!dailyData[date]) {
                    dailyData[date] = { income: 0, expense: 0, profit: 0 };
                }
                
                if (record.type.startsWith('收入')) {
                    dailyData[date].income += amount;
                    totalIncome += amount;
                } else if (record.type.startsWith('费用')) {
                    dailyData[date].expense += amount;
                    totalExpense += amount;
                }
                
                dailyData[date].profit = dailyData[date].income - dailyData[date].expense;
            });
            
            // 转换为图表数据格式
            const dates = Object.keys(dailyData).sort();
            const incomeData = dates.map(date => dailyData[date].income);
            const expenseData = dates.map(date => dailyData[date].expense);
            const profitData = dates.map(date => dailyData[date].profit);
            
            const totalProfit = totalIncome - totalExpense;
            
            return {
                dates,
                incomeData,
                expenseData,
                profitData,
                totalIncome,
                totalExpense,
                totalProfit,
                rawRecords: records
            };
        }
        
        // 增量更新图表而不是重建
        function updateChartsWithData(data) {
            // 更新统计数据显示
            document.getElementById('totalIncome').textContent = data.totalIncome.toFixed(2);
            document.getElementById('totalExpense').textContent = data.totalExpense.toFixed(2);
            document.getElementById('totalProfit').textContent = data.totalProfit.toFixed(2);
            
            // 格式化日期标签为更友好的格式
            const formattedDates = data.dates.map(date => {
                const d = new Date(date);
                return `${d.getMonth() + 1}/${d.getDate()}`;
            });
            
            // 更新利润图表
            if (profitChart) {
                profitChart.data.labels = formattedDates;
                profitChart.data.datasets[0].data = data.profitData;
                profitChart.update();
            } else {
                initProfitChart(formattedDates, data.profitData);
            }
            
            // 更新收入图表
            if (incomeChart) {
                incomeChart.data.labels = formattedDates;
                incomeChart.data.datasets[0].data = data.incomeData;
                incomeChart.update();
            } else {
                initIncomeChart(formattedDates, data.incomeData);
            }
            
            // 更新费用图表
            if (expenseChart) {
                expenseChart.data.labels = formattedDates;
                expenseChart.data.datasets[0].data = data.expenseData;
                expenseChart.update();
            } else {
                initExpenseChart(formattedDates, data.expenseData);
            }
        }
        
        // 分页加载记录
        let currentPage = 1;
        const PAGE_SIZE = 20;
        let allFilteredRecords = [];
        
        function loadRecordsWithPagination(startDate, endDate) {
            if (!currentUser) return;
            
            showLoader('加载记录中...');
            const recordsRef = database.ref(`users/${currentUser.uid}/records`);
            
            recordsRef.orderByChild('date')
                .startAt(startDate)
                .endAt(endDate)
                .once('value')
                .then(snapshot => {
                    hideLoader();
                    const data = snapshot.val() || {};
                    
                    // 转换为数组并按日期排序
                    allFilteredRecords = Object.values(data).sort((a, b) => {
                        // 先按日期降序
                        if (a.date !== b.date) {
                            return new Date(b.date) - new Date(a.date);
                        }
                        // 同一天，按类型排序
                        return a.type.localeCompare(b.type);
                    });
                    
                    // 重置为第一页并显示
                    currentPage = 1;
                    displayCurrentPage();
                    
                    // 显示或隐藏页码控制器
                    const paginationControls = document.getElementById('paginationControls');
                    if (paginationControls) {
                        paginationControls.style.display = allFilteredRecords.length > PAGE_SIZE ? 'flex' : 'none';
                    }
                })
                .catch(error => {
                    hideLoader();
                    console.error('加载记录失败:', error);
                    alert('加载记录失败，请检查网络连接。');
                });
        }
        
        function displayCurrentPage() {
            const recordsContainer = document.getElementById('detailsRecordsList');
            if (!recordsContainer) return;
            
            // 计算当前页的记录
            const start = (currentPage - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const pageRecords = allFilteredRecords.slice(start, end);
            
            // 清空容器
            recordsContainer.innerHTML = '';
            
            if (pageRecords.length === 0) {
                recordsContainer.innerHTML = '<div class="no-records">该时间段内没有记录</div>';
                return;
            }
            
            // 添加记录
            let currentDate = '';
            pageRecords.forEach(record => {
                // 如果是新的日期，添加日期分隔符
                if (record.date !== currentDate) {
                    currentDate = record.date;
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'date-header';
                    
                    // 格式化日期为更友好的格式
                    const recordDate = new Date(record.date);
                    const formattedDate = `${recordDate.getFullYear()}年${recordDate.getMonth() + 1}月${recordDate.getDate()}日`;
                    
                    dateHeader.textContent = formattedDate;
                    recordsContainer.appendChild(dateHeader);
                }
                
                // 创建记录项
                const recordItem = document.createElement('div');
                recordItem.className = 'detail-record-item';
                
                const typeClass = record.type.startsWith('收入') ? 'income' : 'expense';
                
                recordItem.innerHTML = `
                    <div class="record-type ${typeClass}">${record.type}</div>
                    <div class="record-amount ${typeClass}">${parseFloat(record.amount).toFixed(2)}</div>
                `;
                
                recordsContainer.appendChild(recordItem);
            });
            
            // 更新页码显示
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = Math.ceil(allFilteredRecords.length / PAGE_SIZE);
            
            // 启用/禁用页码按钮
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage >= Math.ceil(allFilteredRecords.length / PAGE_SIZE);
        }
        
        function goToNextPage() {
            if (currentPage < Math.ceil(allFilteredRecords.length / PAGE_SIZE)) {
                currentPage++;
                displayCurrentPage();
            }
        }
        
        function goToPrevPage() {
            if (currentPage > 1) {
                currentPage--;
                displayCurrentPage();
            }
        }

        // DOM元素
        const datePicker = document.getElementById('datePicker');
        const dateButton = document.getElementById('dateButton');
        const dateDisplay = document.getElementById('dateDisplay');
        const incomeTotal = document.getElementById('incomeTotal');
        const expenseTotal = document.getElementById('expenseTotal');
        const profitTotal = document.getElementById('profitTotal');
        const recordsList = document.getElementById('recordsList');
        const addButton = document.getElementById('addButton');
        const addModal = document.getElementById('addModal');
        const amountInput = document.getElementById('amount');
        const typeOptions = document.getElementById('typeOptions');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveBtn = document.getElementById('saveBtn');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        const authSection = document.getElementById('authSection');
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authError = document.getElementById('authError');
        const appContent = document.getElementById('appContent');
        const exportCsvBtn = document.getElementById('exportCsv');
        const exportExcelBtn = document.getElementById('exportExcel');
        const forgotPassword = document.getElementById('forgotPassword');
        const resetModal = document.getElementById('resetModal');
        const resetEmail = document.getElementById('resetEmail');
        const resetCancelBtn = document.getElementById('resetCancelBtn');
        const resetSubmitBtn = document.getElementById('resetSubmitBtn');
        const offlineNotice = document.getElementById('offlineNotice');
        const logoutButton = document.getElementById('logoutButton');
        const detailsButton = document.getElementById('detailsButton');
        const detailsModal = document.getElementById('detailsModal');
        const detailsCloseBtn = document.getElementById('detailsCloseBtn');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const detailsExportCsvBtn = document.getElementById('detailsExportCsv');
        const detailsExportExcelBtn = document.getElementById('detailsExportExcel');

        // 显示/隐藏加载指示器
        function showLoader(show, text = "数据加载中...") {
            loaderText.textContent = text;
            loader.style.display = show ? 'flex' : 'none';
        }

        // 更新网络状态
        function updateNetworkStatus() {
            isOnline = navigator.onLine;
            if (isOnline) {
                offlineNotice.classList.remove('show');
                if (currentUser) {
                    syncPendingChanges();
                }
            } else {
                offlineNotice.classList.add('show');
            }
        }

        // 同步离线时的更改
        async function syncPendingChanges() {
            const pendingChanges = JSON.parse(localStorage.getItem('pendingChanges')) || [];
            if (pendingChanges.length === 0) return;
            
            showLoader(true, "正在同步离线更改...");
            
            try {
                for (const change of pendingChanges) {
                    if (change.type === 'add') {
                        await database.ref(`users/${currentUser.uid}/records/${change.data.id}`).set(change.data);
                    } else if (change.type === 'delete') {
                        await database.ref(`users/${currentUser.uid}/records/${change.id}`).remove();
                    }
                }
                
                localStorage.removeItem('pendingChanges');
                await loadRecordsFromFirebase();
                updateUI();
                updateDetailsCharts();
            } catch (error) {
                console.error("同步失败:", error);
            } finally {
                showLoader(false);
            }
        }

        // 初始化
        async function init() {
            showLoader(true);
            // 确保每次初始化时都使用当天日期
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            selectedDate = `${yyyy}-${mm}-${dd}`;
            
            datePicker.value = selectedDate;
            dateDisplay.textContent = formatDate(selectedDate);
            
            // 修改日期选择器实现
            document.getElementById('dateButton').addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // 显示日期选择动画效果
                const dateDisplay = document.querySelector('.date-display');
                dateDisplay.classList.add('date-select-animation');
                
                // 显示苹果风格日历选择器
                showAppleCalendar();
            });
            
            // 日期导航按钮实现
            document.getElementById('prevDayButton').addEventListener('click', () => {
                navigateDate(-1);
            });
            
            document.getElementById('nextDayButton').addEventListener('click', () => {
                navigateDate(1);
            });
            
            document.getElementById('todayButton').addEventListener('click', () => {
                const today = new Date();
                // 修复时区问题：格式化为YYYY-MM-DD格式，手动处理以避免时区偏移
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                selectedDate = `${yyyy}-${mm}-${dd}`;
                
                datePicker.value = selectedDate;
                dateDisplay.textContent = formatDate(selectedDate);
                updateUI();
                
                // 添加选择确认的视觉效果
                const dateDisplayElement = document.querySelector('.date-display');
                dateDisplayElement.classList.add('date-selected');
                setTimeout(() => {
                    dateDisplayElement.classList.remove('date-selected');
                }, 500);
            });
            
            datePicker.addEventListener('change', (e) => {
                selectedDate = e.target.value;
                document.querySelector('.date-display-text').textContent = formatDate(selectedDate);
                
                // 添加选择确认的视觉效果
                const dateDisplay = document.querySelector('.date-display');
                dateDisplay.classList.add('date-selected');
                setTimeout(() => {
                    dateDisplay.classList.remove('date-selected');
                }, 500);
                
                updateUI();
            });
            
            // 初始化日历模态框的事件监听
            document.getElementById('prevMonthBtn').addEventListener('click', () => {
                navigateCalendarMonth(-1);
            });
            
            document.getElementById('nextMonthBtn').addEventListener('click', () => {
                navigateCalendarMonth(1);
            });
            
            document.getElementById('todayCalendarBtn').addEventListener('click', () => {
                const today = new Date();
                currentCalendarMonth = today.getMonth();
                currentCalendarYear = today.getFullYear();
                renderCalendar(currentCalendarYear, currentCalendarMonth);
                
                // 选择今天的日期
                // 使用本地时间而不是UTC时间，避免时区问题
                selectDate(today.getFullYear(), today.getMonth(), today.getDate());
            });
            
            document.getElementById('closeCalendarBtn').addEventListener('click', () => {
                document.getElementById('calendarModal').style.display = 'none';
            });
            
            document.getElementById('calendarModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('calendarModal')) {
                    document.getElementById('calendarModal').style.display = 'none';
                }
            });
            
            // 初始化详细数据中的日期范围预设按钮
            const rangeButtons = document.querySelectorAll('.range-preset-button');
            rangeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // 移除所有按钮的active类
                    rangeButtons.forEach(btn => btn.classList.remove('active'));
                    // 给当前按钮添加active类
                    button.classList.add('active');
                    
                    const days = button.dataset.days;
                    const range = button.dataset.range;
                    
                    const endDate = new Date();
                    let startDate = new Date();
                    
                    if (days) {
                        // 如果是基于天数的预设
                        startDate.setDate(endDate.getDate() - parseInt(days));
                    } else if (range) {
                        // 如果是基于特定范围的预设
                        if (range === 'month') {
                            // 本月
                            startDate = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
                        } else if (range === 'last-month') {
                            // 上月
                            startDate = new Date(endDate.getFullYear(), endDate.getMonth() - 1, 1);
                            endDate = new Date(endDate.getFullYear(), endDate.getMonth(), 0);
                        } else if (range === 'year') {
                            // 今年
                            startDate = new Date(endDate.getFullYear(), 0, 1);
                        }
                    }
                    
                    // 更新日期输入框
                    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
                    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
                });
            });
            
            // 日期范围输入框变更事件
            document.getElementById('startDate').addEventListener('change', () => {
                // 移除所有预设按钮的active类
                rangeButtons.forEach(btn => btn.classList.remove('active'));
            });
            
            document.getElementById('endDate').addEventListener('change', () => {
                // 移除所有预设按钮的active类
                rangeButtons.forEach(btn => btn.classList.remove('active'));
            });
            
            // 应用日期筛选按钮
            document.getElementById('applyDatesBtn').addEventListener('click', updateDetailsCharts);
            
            // 检查自动登录
            await checkAutoLogin();
            
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
            updateNetworkStatus();
            
            // 优化认证状态监听
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    loginForm.style.display = 'none';
                    authSection.style.display = 'none';
                    appContent.style.display = 'block';
                    
                    try {
                        // 先设置当天日期，确保UI至少显示日期和标题
                        const today = new Date();
                        const yyyy = today.getFullYear();
                        const mm = String(today.getMonth() + 1).padStart(2, '0');
                        const dd = String(today.getDate()).padStart(2, '0');
                        selectedDate = `${yyyy}-${mm}-${dd}`;
                        datePicker.value = selectedDate;
                        dateDisplay.textContent = formatDate(selectedDate);
                        
                        // 显示加载中的UI，提高用户体验
                        incomeTotal.textContent = "...";
                        expenseTotal.textContent = "...";
                        profitTotal.textContent = "...";
                        recordsList.innerHTML = '<div class="no-records">加载中...</div>';
                        
                        // 设置加载数据的超时
                        const loadPromise = loadRecordsFromFirebase();
                        const timeoutPromise = new Promise((resolve) => {
                            setTimeout(() => {
                                console.warn('数据加载超时，使用空数据');
                                resolve();
                            }, 10000);
                        });
                        
                        await Promise.race([loadPromise, timeoutPromise]);
                        
                        updateUI();
                    } catch (error) {
                        console.error("加载数据失败:", error);
                        recordsList.innerHTML = '<div class="no-records">加载失败，请重试</div>';
                    }
                } else {
                    currentUser = null;
                    loginForm.style.display = 'block';
                    authSection.style.display = 'block';
                    appContent.style.display = 'none';
                    records = [];
                }
                showLoader(false);
            });
            
            addButton.addEventListener('click', () => {
                if (!currentUser) return;
                addModal.style.display = 'flex';
                amountInput.focus();
                selectedType = null;
                updateTypeSelection();
            });
            
            cancelBtn.addEventListener('click', () => {
                addModal.style.display = 'none';
                amountInput.value = '';
                selectedType = null;
            });
            
            saveBtn.addEventListener('click', saveRecord);
            
            loginButton.addEventListener('click', handleLogin);
            
            logoutButton.addEventListener('click', handleLogout);
            
            exportCsvBtn.addEventListener('click', exportToCsv);
            exportExcelBtn.addEventListener('click', exportToExcel);
            
            forgotPassword.addEventListener('click', () => {
                resetModal.style.display = 'flex';
                resetEmail.value = emailInput.value || '';
                resetEmail.focus();
            });
            
            resetCancelBtn.addEventListener('click', () => {
                resetModal.style.display = 'none';
                resetEmail.value = '';
            });
            
            resetSubmitBtn.addEventListener('click', handlePasswordReset);
            
            typeOptions.addEventListener('click', (e) => {
                const option = e.target.closest('.type-option');
                if (option) {
                    selectedType = option.dataset.type;
                    updateTypeSelection();
                }
            });
            
            addModal.addEventListener('click', (e) => {
                if (e.target === addModal) {
                    addModal.style.display = 'none';
                    amountInput.value = '';
                    selectedType = null;
                }
            });
            
            resetModal.addEventListener('click', (e) => {
                if (e.target === resetModal) {
                    resetModal.style.display = 'none';
                    resetEmail.value = '';
                }
            });

            detailsButton.addEventListener('click', () => {
                detailsModal.style.display = 'flex';
                initCharts();
                updateDetailsCharts();
            });

            detailsCloseBtn.addEventListener('click', () => {
                detailsModal.style.display = 'none';
            });

            detailsModal.addEventListener('click', (e) => {
                if (e.target === detailsModal) {
                    detailsModal.style.display = 'none';
                }
            });

            startDateInput.addEventListener('change', updateDetailsCharts);
            endDateInput.addEventListener('change', updateDetailsCharts);

            detailsExportCsvBtn.addEventListener('click', exportDetailsToCsv);
            detailsExportExcelBtn.addEventListener('click', exportDetailsToExcel);

            amountInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveRecord();
                }
            });
            
            resetEmail.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handlePasswordReset();
                }
            });

            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
                document.body.classList.add('standalone');
            }
        }

        // 格式化日期显示
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // 更新类型选择状态
        function updateTypeSelection() {
            const options = typeOptions.querySelectorAll('.type-option');
            options.forEach(option => {
                if (option.dataset.type === selectedType) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        // 处理退出登录
        async function handleLogout() {
            try {
                showLoader(true, "正在退出...");
                await auth.signOut();
            } catch (error) {
                console.error("退出失败:", error);
                authError.textContent = "退出失败，请重试";
            } finally {
                showLoader(false);
            }
        }

        // 处理登录/注册
        async function handleLogin() {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!email || !password) {
                authError.textContent = "请输入邮箱和密码";
                return;
            }
            
            showLoader(true, "正在登录...");
            authError.textContent = "";
            
            try {
                // 设置登录超时为8秒
                const loginPromise = auth.signInWithEmailAndPassword(email, password);
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('登录超时，请检查网络连接')), 8000)
                );
                
                await Promise.race([loginPromise, timeoutPromise]);
                
                // 登录成功后保存信息
                localStorage.setItem('userEmail', email);
                localStorage.setItem('userPassword', password);
                
                // 先渲染空UI，提高感知速度
                authSection.style.display = 'none';
                appContent.style.display = 'block';
                
            } catch (loginError) {
                console.error("登录错误:", loginError);
                
                if (loginError.message === '登录超时，请检查网络连接') {
                    authError.textContent = loginError.message;
                } else if (loginError.code === 'auth/user-not-found') {
                    try {
                        // 设置注册超时
                        const signupPromise = auth.createUserWithEmailAndPassword(email, password);
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('注册超时，请检查网络连接')), 8000)
                        );
                        
                        await Promise.race([signupPromise, timeoutPromise]);
                        
                        localStorage.setItem('userEmail', email);
                        localStorage.setItem('userPassword', password);
                        authError.textContent = "注册成功，已自动登录";
                        
                        // 先渲染空UI，提高感知速度
                        authSection.style.display = 'none';
                        appContent.style.display = 'block';
                    } catch (signupError) {
                        console.error("注册错误:", signupError);
                        authError.textContent = getAuthErrorMessage(signupError);
                    }
                } else {
                    authError.textContent = getAuthErrorMessage(loginError);
                }
            } finally {
                showLoader(false);
            }
        }

        // 处理密码重置
        async function handlePasswordReset() {
            const email = resetEmail.value.trim();
            
            if (!email) {
                authError.textContent = "请输入注册邮箱";
                return;
            }
            
            showLoader(true, "正在发送重置邮件...");
            
            try {
                await auth.sendPasswordResetEmail(email);
                resetModal.style.display = 'none';
                resetEmail.value = '';
                authError.textContent = "密码重置邮件已发送，请检查您的邮箱";
            } catch (error) {
                console.error("密码重置错误:", error);
                authError.textContent = getAuthErrorMessage(error);
            } finally {
                showLoader(false);
            }
        }

        // 获取认证错误信息
        function getAuthErrorMessage(error) {
            const errorMap = {
                'auth/invalid-email': '邮箱格式不正确，请检查',
                'auth/user-disabled': '账户已被禁用，请联系管理员',
                'auth/user-not-found': '账户不存在，将尝试注册',
                'auth/wrong-password': '密码错误，请重试',
                'auth/email-already-in-use': '邮箱已被注册，请直接登录',
                'auth/weak-password': '密码强度不足(至少6个字符)',
                'auth/operation-not-allowed': '未启用邮箱/密码登录，请检查Firebase配置',
                'auth/too-many-requests': '尝试次数过多，请稍后再试',
                'auth/network-request-failed': '网络连接失败，请检查网络',
                'auth/missing-email': '请输入邮箱地址'
            };
            
            return errorMap[error.code] || `操作失败: ${error.message}`;
        }

        // 从Firebase加载数据 - 优化性能
        async function loadRecordsFromFirebase() {
            if (!currentUser) return;
            
            // 检查今天的数据是否在缓存中，如果有则优先使用缓存
            const today = new Date().toISOString().split('T')[0];
            const cachedTodayRecords = dataCache.getRecords(today);
            
            if (cachedTodayRecords && !dataCache.isExpired(`record_${today}`)) {
                // 使用缓存的今日数据快速渲染UI
                const todayRecords = cachedTodayRecords;
                // 筛选出今天的记录
                const filteredRecords = todayRecords.filter(record => record.date === today);
                records = [...filteredRecords];
                updateUI();
                
                // 然后在后台继续加载完整数据
                setTimeout(() => fetchCompleteRecords(), 100);
                return Promise.resolve();
            }
            
            return fetchCompleteRecords();
        }
        
        // 后台加载完整记录
        function fetchCompleteRecords() {
            return new Promise((resolve, reject) => {
                // 设置加载超时
                const timeoutId = setTimeout(() => {
                    console.warn('数据加载超时，使用缓存数据');
                    resolve();
                }, 8000); // 8秒超时
                
                database.ref(`users/${currentUser.uid}/records`)
                    .limitToLast(100) // 限制只加载最近100条记录，提高加载速度
                    .once('value')
                    .then((snapshot) => {
                        clearTimeout(timeoutId); // 清除超时
                        const data = snapshot.val();
                        records = data ? Object.values(data) : [];
                        records.sort((a, b) => new Date(b.date) - new Date(a.date));
                        
                        // 缓存按日期分组的记录
                        const recordsByDate = {};
                        records.forEach(record => {
                            if (!recordsByDate[record.date]) {
                                recordsByDate[record.date] = [];
                            }
                            recordsByDate[record.date].push(record);
                        });
                        
                        // 保存到缓存
                        Object.keys(recordsByDate).forEach(date => {
                            dataCache.setRecords(date, recordsByDate[date]);
                        });
                        
                        updateUI();
                        resolve();
                    })
                    .catch((error) => {
                        clearTimeout(timeoutId); // 清除超时
                        console.error('加载数据失败:', error);
                        // 如果加载失败但有缓存，使用缓存
                        const cachedDates = Object.keys(dataCache.records);
                        if (cachedDates.length > 0) {
                            records = [];
                            cachedDates.forEach(date => {
                                records = [...records, ...dataCache.getRecords(date)];
                            });
                            records.sort((a, b) => new Date(b.date) - new Date(a.date));
                            updateUI();
                            resolve();
                        } else {
                            reject(error);
                        }
                    });
            });
        }

        // 更新主界面UI
        function updateUI() {
            const filteredRecords = records.filter(record => record.date === selectedDate);
            
            const dailyIncome = filteredRecords
                .filter(record => record.type.startsWith('收入'))
                .reduce((sum, record) => sum + record.amount, 0);
                
            const dailyExpense = filteredRecords
                .filter(record => record.type.startsWith('费用'))
                .reduce((sum, record) => sum + record.amount, 0);
                
            const dailyProfit = dailyIncome - dailyExpense;
            
            incomeTotal.textContent = dailyIncome.toFixed(2);
            expenseTotal.textContent = dailyExpense.toFixed(2);
            profitTotal.textContent = dailyProfit.toFixed(2);
            
            profitTotal.style.color = dailyProfit >= 0 ? 'var(--primary-green)' : 'var(--primary-red)';
            
            renderRecords(filteredRecords);
        }

        // 渲染记录列表
        function renderRecords(recordsToRender) {
            if (recordsToRender.length === 0) {
                recordsList.innerHTML = '<div class="no-records">暂无记录</div>';
                return;
            }
            
            let html = '';
            recordsToRender.forEach(record => {
                const isIncome = record.type.startsWith('收入');
                html += `
                    <div class="record-item" data-id="${record.id}">
                        <span class="record-type">${record.type}</span>
                        <span class="record-amount ${isIncome ? 'income' : 'expense'}">${record.amount.toFixed(2)}</span>
                        <button class="delete-btn" onclick="deleteRecord('${record.id}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                `;
            });
            
            recordsList.innerHTML = html;
        }

        // 保存记录
        async function saveRecord() {
            if (!currentUser) return;
            
            const amount = amountInput.value.trim();
            
            if (!amount || isNaN(amount)) {
                alert('请输入有效的金额');
                return;
            }
            
            if (!selectedType) {
                alert('请选择记录类型');
                return;
            }
            
            const newRecord = new Record(amount, selectedType, selectedDate);
            
            try {
                showLoader(true, "正在保存...");
                
                if (isOnline) {
                    await database.ref(`users/${currentUser.uid}/records/${newRecord.id}`).set(newRecord);
                } else {
                    const pendingChanges = JSON.parse(localStorage.getItem('pendingChanges')) || [];
                    pendingChanges.push({
                        type: 'add',
                        data: newRecord
                    });
                    localStorage.setItem('pendingChanges', JSON.stringify(pendingChanges));
                }
                
                records.push(newRecord);
                
                amountInput.value = '';
                selectedType = null;
                addModal.style.display = 'none';
                updateUI();
                updateDetailsCharts();
            } catch (error) {
                console.error("保存失败:", error);
                alert('保存失败，请检查网络连接');
            } finally {
                showLoader(false);
            }
        }

        // 删除记录
        async function deleteRecord(id) {
            if (!currentUser) return;
            if (!confirm('确定要删除这条记录吗？')) return;
            
            try {
                showLoader(true, "正在删除...");
                
                if (isOnline) {
                    await database.ref(`users/${currentUser.uid}/records/${id}`).remove();
                } else {
                    const pendingChanges = JSON.parse(localStorage.getItem('pendingChanges')) || [];
                    pendingChanges.push({
                        type: 'delete',
                        id: id
                    });
                    localStorage.setItem('pendingChanges', JSON.stringify(pendingChanges));
                }
                
                records = records.filter(record => record.id !== id);
                
                updateUI();
                updateDetailsCharts();
            } catch (error) {
                console.error("删除失败:", error);
                alert('删除失败，请检查网络连接');
            } finally {
                showLoader(false);
            }
        }

        // 初始化图表
        function initCharts() {
            if (profitChart) profitChart.destroy();
            if (incomeChart) incomeChart.destroy();
            if (expenseChart) expenseChart.destroy();

            const chartConfig = {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false, // 鼠标不需要精确交叉点
                            bodyFont: {
                                size: 14 // 增大提示文字大小
                            },
                            padding: 10, // 增加提示框内边距
                            backgroundColor: 'rgba(0,0,0,0.7)',
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                font: {
                                    size: 12 // 增大刻度字体
                                },
                                padding: 8 // 增加刻度与轴的距离
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 12 // 增大刻度字体
                                },
                                maxRotation: 30, // 允许标签旋转以避免重叠
                                padding: 8 // 增加刻度与轴的距离
                            }
                        }
                    },
                    hover: {
                        mode: 'nearest',
                        intersect: false // 不需要精确交叉
                    },
                    elements: {
                        point: {
                            radius: 4, // 增大点的半径
                            hoverRadius: 8 // 悬停时增大点的半径
                        },
                        line: {
                            tension: 0.4 // 平滑曲线
                        }
                    },
                    interaction: {
                        mode: 'nearest', // 使用最近点模式
                        axis: 'xy', // 横纵两轴都检测
                        intersect: false // 不需要精确交叉
                    }
                }
            };

            profitChart = new Chart(document.getElementById('profitChart'), {
                ...chartConfig,
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        borderColor: '#007AFF',
                        backgroundColor: 'rgba(0,122,255,0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                }
            });

            incomeChart = new Chart(document.getElementById('incomeChart'), {
                ...chartConfig,
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        borderColor: '#34C759',
                        backgroundColor: 'rgba(52,199,89,0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                }
            });

            expenseChart = new Chart(document.getElementById('expenseChart'), {
                ...chartConfig,
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        borderColor: '#FF3B30',
                        backgroundColor: 'rgba(255,59,48,0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                }
            });
        }

        // 更新详细数据图表
        function updateDetailsCharts() {
            const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

            // 确保图表已初始化
            if (!profitChart || !incomeChart || !expenseChart) {
                initCharts();
            }

            let filteredRecords = records;
            if (startDate || endDate) {
                filteredRecords = records.filter(record => {
                    const recordDate = new Date(record.date);
                    return (!startDate || recordDate >= startDate) && (!endDate || recordDate <= endDate);
                });
            }

            // 获取最近7天的数据
            const last7Days = Array.from({length: 7}, (_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - i);
                return date.toISOString().split('T')[0];
            }).reverse();

            const dailyData = {};
            last7Days.forEach(date => {
                dailyData[date] = {
                    income: 0,
                    expense: 0,
                    profit: 0
                };
            });

            // 处理记录并填充数据
            filteredRecords.forEach(record => {
                // 确保日期存在于数据结构中
                if (!dailyData[record.date] && last7Days.includes(record.date)) {
                    dailyData[record.date] = { income: 0, expense: 0, profit: 0 };
                }
                
                if (dailyData[record.date]) {
                    if (record.type.startsWith('收入')) {
                        dailyData[record.date].income += record.amount;
                        dailyData[record.date].profit += record.amount;
                    } else {
                        dailyData[record.date].expense += record.amount;
                        dailyData[record.date].profit -= record.amount;
                    }
                }
            });

            // 更新图表数据
            profitChart.data.labels = last7Days.map(date => formatDate(date));
            profitChart.data.datasets[0].data = last7Days.map(date => dailyData[date].profit);

            incomeChart.data.labels = last7Days.map(date => formatDate(date));
            incomeChart.data.datasets[0].data = last7Days.map(date => dailyData[date].income);

            expenseChart.data.labels = last7Days.map(date => formatDate(date));
            expenseChart.data.datasets[0].data = last7Days.map(date => dailyData[date].expense);

            // 计算并更新总数据 - 使用所有过滤后的记录，不只是近7天
            const totals = filteredRecords.reduce((acc, record) => {
                if (record.type.startsWith('收入')) {
                    acc.income += record.amount;
                    acc.profit += record.amount;
                } else if (record.type.startsWith('费用')) {
                    acc.expense += record.amount;
                    acc.profit -= record.amount;
                }
                return acc;
            }, { income: 0, expense: 0, profit: 0 });

            // 更新DOM上的总计数据
            document.getElementById('totalIncome').textContent = totals.income.toFixed(2);
            document.getElementById('totalExpense').textContent = totals.expense.toFixed(2);
            document.getElementById('totalProfit').textContent = totals.profit.toFixed(2);

            // 更新图表
            profitChart.update();
            incomeChart.update();
            expenseChart.update();
        }

        // 主界面导出为CSV
        function exportToCsv() {
            const recordsToExport = selectedDate ? 
                records.filter(record => record.date === selectedDate) : 
                records;
            
            if (recordsToExport.length === 0) {
                alert('没有可导出的记录');
                return;
            }
            
            let csv = '日期,类型,金额\n';
            recordsToExport.forEach(record => {
                csv += `${record.date},${record.type},${record.amount.toFixed(2)}\n`;
            });
            
            exportFile(csv, 'csv', `记账数据${selectedDate ? `_${selectedDate}` : ''}_${new Date().toLocaleDateString()}`);
        }

        // 主界面导出为Excel
        function exportToExcel() {
            const recordsToExport = selectedDate ? 
                records.filter(record => record.date === selectedDate) : 
                records;
            
            if (recordsToExport.length === 0) {
                alert('没有可导出的记录');
                return;
            }
            
            const data = [
                ['日期', '类型', '金额'],
                ...recordsToExport.map(record => [record.date, record.type, record.amount.toFixed(2)])
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "记账数据");
            XLSX.writeFile(wb, `记账数据${selectedDate ? `_${selectedDate}` : ''}_${new Date().toLocaleDateString()}.xlsx`);
        }

        // 详细数据导出为CSV
        function exportDetailsToCsv() {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            const recordsToExport = getFilteredRecords(startDate, endDate);
            
            if (recordsToExport.length === 0) {
                alert('指定范围内没有记录');
                return;
            }
            
            let csv = '日期,类型,金额\n';
            recordsToExport.forEach(record => {
                csv += `${record.date},${record.type},${record.amount.toFixed(2)}\n`;
            });
            
            exportFile(csv, 'csv', `详细记账数据_${startDate || '开始'}_至_${endDate || '现在'}_${new Date().toLocaleDateString()}`);
        }

        // 详细数据导出为Excel
        function exportDetailsToExcel() {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            const recordsToExport = getFilteredRecords(startDate, endDate);
            
            if (recordsToExport.length === 0) {
                alert('指定范围内没有记录');
                return;
            }
            
            const data = [
                ['日期', '类型', '金额'],
                ...recordsToExport.map(record => [record.date, record.type, record.amount.toFixed(2)])
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "详细记账数据");
            XLSX.writeFile(wb, `详细记账数据_${startDate || '开始'}_至_${endDate || '现在'}_${new Date().toLocaleDateString()}.xlsx`);
        }

        // 获取过滤后的记录
        function getFilteredRecords(startDate, endDate) {
            let filteredRecords = records;
            if (startDate || endDate) {
                filteredRecords = records.filter(record => {
                    const recordDate = new Date(record.date);
                    return (!startDate || recordDate >= new Date(startDate)) && (!endDate || recordDate <= new Date(endDate));
                });
            }
            return filteredRecords;
        }

        // 导出文件通用函数
        function exportFile(content, type, filename) {
            const blob = new Blob([content], { type: `text/${type};charset=utf-8;` });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${filename}.${type}`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // 全局函数
        window.deleteRecord = deleteRecord;

        // 添加自动登录功能
        async function checkAutoLogin() {
            const savedEmail = localStorage.getItem('userEmail');
            const savedPassword = localStorage.getItem('userPassword');
            
            if (savedEmail && savedPassword) {
                emailInput.value = savedEmail;
                passwordInput.value = savedPassword;
                
                try {
                    // 使用 Promise.race 设置8秒超时
                    await Promise.race([
                        auth.signInWithEmailAndPassword(savedEmail, savedPassword),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('登录超时')), 8000)
                        )
                    ]);
                    
                    // 自动登录成功后，确保日期是当天
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    selectedDate = `${yyyy}-${mm}-${dd}`;
                    datePicker.value = selectedDate;
                    dateDisplay.textContent = formatDate(selectedDate);
                } catch (error) {
                    console.error("自动登录失败:", error);
                    // 清除可能过期的登录信息
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('userPassword');
                }
            }
        }

        // 新增日期导航功能
        function navigateDate(days) {
            const currentDate = new Date(selectedDate);
            currentDate.setDate(currentDate.getDate() + days);
            selectedDate = currentDate.toISOString().split('T')[0];
            datePicker.value = selectedDate;
            dateDisplay.textContent = formatDate(selectedDate);
            updateUI();
        }

        // 启动应用
        document.addEventListener('DOMContentLoaded', init);

        // 检测是否为iOS设备
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }

        // 苹果风格日历选择器全局变量
        let currentCalendarMonth;
        let currentCalendarYear;
        
        // 显示苹果风格的日历选择器
        function showAppleCalendar() {
            const calendarModal = document.getElementById('calendarModal');
            calendarModal.style.display = 'flex';
            
            // 初始化日历为当前选择的日期或今天
            const date = selectedDate ? new Date(selectedDate) : new Date();
            currentCalendarMonth = date.getMonth();
            currentCalendarYear = date.getFullYear();
            
            // 渲染日历
            renderCalendar(currentCalendarYear, currentCalendarMonth);
        }
        
        // 渲染日历
        function renderCalendar(year, month, animation = '') {
            const calendarDays = document.getElementById('calendarDays');
            const currentMonthYear = document.getElementById('currentMonthYear');
            
            // 清空现有内容并应用动画类
            calendarDays.innerHTML = '';
            calendarDays.className = 'calendar-days';
            
            if (animation) {
                calendarDays.classList.add(animation);
            }
            
            // 设置当前月份和年份显示
            const monthNames = ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"];
            currentMonthYear.textContent = `${year}年${monthNames[month]}`;
            
            // 计算当月第一天
            const firstDay = new Date(year, month, 1);
            
            // 计算当月有多少天
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // 获取当月第一天是星期几 (0-6, 0 为星期日)
            const firstDayIndex = firstDay.getDay();
            
            // 获取上个月的最后几天，用于填充当月第一周
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            
            // 计算需要显示的上个月天数
            const prevMonthDays = firstDayIndex;
            
            // 获取今天的日期信息，用于高亮今天
            const today = new Date();
            const todayDate = today.getDate();
            const todayMonth = today.getMonth();
            const todayYear = today.getFullYear();
            
            // 获取当前选择日期的信息
            const selectedDateObj = selectedDate ? new Date(selectedDate) : null;
            const selectedDay = selectedDateObj ? selectedDateObj.getDate() : null;
            const selectedMonth = selectedDateObj ? selectedDateObj.getMonth() : null;
            const selectedYear = selectedDateObj ? selectedDateObj.getFullYear() : null;
            
            // 生成日历网格，先填充上个月的最后几天
            for (let i = prevMonthDays - 1; i >= 0; i--) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('calendar-day', 'other-month');
                dayElement.textContent = prevMonthLastDay - i;
                
                // 添加点击事件 - 修复：使用闭包保存当前的值
                const currentDay = prevMonthLastDay - i; // 保存当前日期值
                const prevMonth = month === 0 ? 11 : month - 1;
                const prevYear = month === 0 ? year - 1 : year;
                dayElement.addEventListener('click', () => selectDate(prevYear, prevMonth, currentDay));
                
                calendarDays.appendChild(dayElement);
            }
            
            // 填充当月的天数
            for (let i = 1; i <= daysInMonth; i++) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('calendar-day');
                dayElement.textContent = i;
                
                // 如果是今天，添加特殊样式
                if (i === todayDate && month === todayMonth && year === todayYear) {
                    dayElement.classList.add('today');
                }
                
                // 如果是选中的日期，添加选中样式
                if (i === selectedDay && month === selectedMonth && year === selectedYear) {
                    dayElement.classList.add('selected');
                }
                
                // 添加点击事件 - 修复：使用闭包保存当前的i值
                const currentDay = i; // 保存当前日期值
                dayElement.addEventListener('click', () => selectDate(year, month, currentDay));
                
                calendarDays.appendChild(dayElement);
            }
            
            // 填充下个月的前几天，直到日历网格填满
            const totalDaysDisplayed = prevMonthDays + daysInMonth;
            const nextMonthDays = 42 - totalDaysDisplayed > 7 ? 42 - 7 - totalDaysDisplayed : 42 - totalDaysDisplayed;
            
            for (let i = 1; i <= nextMonthDays; i++) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('calendar-day', 'other-month');
                dayElement.textContent = i;
                
                // 添加点击事件 - 修复：使用闭包保存当前的i值
                const currentDay = i; // 保存当前日期值
                const nextMonth = month === 11 ? 0 : month + 1;
                const nextYear = month === 11 ? year + 1 : year;
                dayElement.addEventListener('click', () => selectDate(nextYear, nextMonth, currentDay));
                
                calendarDays.appendChild(dayElement);
            }
        }
        
        // 选择日期
        function selectDate(year, month, day) {
            // 使用本地时间而不是UTC时间
            // 创建新的日期对象并设置年月日（不使用时分秒）
            const date = new Date(year, month, day);
            
            // 格式化为YYYY-MM-DD格式，使用本地时间
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            const formattedDate = `${yyyy}-${mm}-${dd}`;
            
            // 更新选中日期
            selectedDate = formattedDate;
            datePicker.value = formattedDate;
            dateDisplay.textContent = formatDate(formattedDate);
            
            // 关闭日历模态框
            document.getElementById('calendarModal').style.display = 'none';
            
            // 更新UI
            updateUI();
            
            // 添加选择确认的视觉效果
            const dateDisplayElement = document.querySelector('.date-display');
            dateDisplayElement.classList.add('date-selected');
            setTimeout(() => {
                dateDisplayElement.classList.remove('date-selected');
                dateDisplayElement.classList.remove('date-select-animation');
            }, 500);
        }
        
        // 导航日历月份
        function navigateCalendarMonth(direction) {
            // 更新当前月份
            if (direction === 1) {
                // 前进一个月
                if (currentCalendarMonth === 11) {
                    currentCalendarMonth = 0;
                    currentCalendarYear++;
                } else {
                    currentCalendarMonth++;
                }
                renderCalendar(currentCalendarYear, currentCalendarMonth, 'slide-left');
            } else {
                // 后退一个月
                if (currentCalendarMonth === 0) {
                    currentCalendarMonth = 11;
                    currentCalendarYear--;
                } else {
                    currentCalendarMonth--;
                }
                renderCalendar(currentCalendarYear, currentCalendarMonth, 'slide-right');
            }
        }

        // 显示iOS风格的日期选择器
        function showIOSDatePicker() {
            // 如果已经存在，先移除旧的
            const oldPicker = document.getElementById('ios-date-picker-overlay');
            if (oldPicker) oldPicker.remove();
            
            // 创建日期选择覆盖层
            const overlay = document.createElement('div');
            overlay.id = 'ios-date-picker-overlay';
            overlay.className = 'modal';
            overlay.style.display = 'flex';
            overlay.style.zIndex = '10000';
            
            const currentDate = datePicker.value ? new Date(datePicker.value) : new Date();
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const day = currentDate.getDate();
            
            // 创建内容
            const content = document.createElement('div');
            content.className = 'reset-modal-content';
            content.style.padding = '20px';
            
            // 添加标题
            const title = document.createElement('div');
            title.style.fontSize = '18px';
            title.style.fontWeight = '600';
            title.style.marginBottom = '20px';
            title.style.textAlign = 'center';
            title.textContent = '选择日期';
            content.appendChild(title);
            
            // 添加原生日期输入
            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.value = datePicker.value;
            dateInput.style.width = '100%';
            dateInput.style.fontSize = '16px';
            dateInput.style.padding = '12px';
            dateInput.style.borderRadius = '12px';
            dateInput.style.border = '1px solid rgba(0,0,0,0.1)';
            dateInput.style.marginBottom = '20px';
            dateInput.style.webkitAppearance = 'none';
            content.appendChild(dateInput);
            
            // 添加按钮
            const btnContainer = document.createElement('div');
            btnContainer.style.display = 'flex';
            btnContainer.style.justifyContent = 'space-between';
            btnContainer.style.gap = '12px';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = '取消';
            cancelBtn.className = 'btn btn-cancel';
            cancelBtn.style.flex = '1';
            
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = '确认';
            confirmBtn.className = 'btn btn-save';
            confirmBtn.style.flex = '1';
            
            btnContainer.appendChild(cancelBtn);
            btnContainer.appendChild(confirmBtn);
            content.appendChild(btnContainer);
            
            overlay.appendChild(content);
            document.body.appendChild(overlay);
            
            // 添加事件监听
            cancelBtn.addEventListener('click', () => {
                overlay.remove();
            });
            
            confirmBtn.addEventListener('click', () => {
                if (dateInput.value) {
                    // 确保日期格式正确
                    const inputDate = new Date(dateInput.value);
                    
                    // 格式化为YYYY-MM-DD，避免时区问题
                    const yyyy = inputDate.getFullYear();
                    const mm = String(inputDate.getMonth() + 1).padStart(2, '0');
                    const dd = String(inputDate.getDate()).padStart(2, '0');
                    const formattedDate = `${yyyy}-${mm}-${dd}`;
                    
                    datePicker.value = formattedDate;
                    selectedDate = formattedDate;
                    document.querySelector('.date-display-text').textContent = formatDate(formattedDate);
                    updateUI();
                }
                overlay.remove();
            });
            
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
            
            // 自动聚焦
            setTimeout(() => dateInput.focus(), 300);
        }

        // 初始化详细数据中的日期范围预设按钮
        function initDateRangeButtons() {
            const rangeButtons = document.querySelectorAll('.range-preset-button');
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const applyButton = document.getElementById('applyDatesBtn');
            
            // 设置今天为默认结束日期
            const today = new Date();
            endDateInput.value = today.toISOString().split('T')[0];
            
            // 设置30天前为默认开始日期
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
            
            // 默认选中"最近30天"按钮
            document.querySelector('.range-preset-button[data-days="30"]').classList.add('active');
            
            // 初始加载数据
            loadRecordsForDateRange(startDateInput.value, endDateInput.value, data => {
                // 加载详细记录列表
                loadRecordsWithPagination(startDateInput.value, endDateInput.value);
            });
            
            rangeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // 移除所有按钮的激活状态
                    rangeButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // 将当前按钮设为激活状态
                    button.classList.add('active');
                    
                    const today = new Date();
                    let startDate = new Date();
                    
                    // 根据按钮设置日期范围
                    if (button.dataset.days) {
                        // 天数范围
                        const days = parseInt(button.dataset.days);
                        startDate.setDate(today.getDate() - days + 1);
                    } else if (button.dataset.range === 'month') {
                        // 本月
                        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    } else if (button.dataset.range === 'last-month') {
                        // 上月
                        startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        today.setDate(0); // 上月最后一天
                    } else if (button.dataset.range === 'year') {
                        // 今年
                        startDate = new Date(today.getFullYear(), 0, 1);
                    }
                    
                    // 更新输入框
                    startDateInput.value = startDate.toISOString().split('T')[0];
                    endDateInput.value = today.toISOString().split('T')[0];
                    
                    // 加载数据
                    loadRecordsForDateRange(startDateInput.value, endDateInput.value, data => {
                        // 加载详细记录列表
                        loadRecordsWithPagination(startDateInput.value, endDateInput.value);
                    });
                });
            });
            
            // 应用按钮点击事件
            applyButton.addEventListener('click', () => {
                // 移除所有按钮的激活状态
                rangeButtons.forEach(btn => btn.classList.remove('active'));
                
                // 确保日期有效
                if (!startDateInput.value || !endDateInput.value) {
                    alert('请选择有效的开始和结束日期');
                    return;
                }
                
                // 加载数据
                loadRecordsForDateRange(startDateInput.value, endDateInput.value, data => {
                    // 加载详细记录列表
                    loadRecordsWithPagination(startDateInput.value, endDateInput.value);
                });
            });
        }

        // 初始化利润图表
        function initProfitChart(labels, data) {
            const ctx = document.getElementById('profitChart').getContext('2d');
            
            // 创建渐变背景
            const gradient = ctx.createLinearGradient(0, 0, 0, 250);
            gradient.addColorStop(0, 'rgba(0, 122, 255, 0.2)');
            gradient.addColorStop(1, 'rgba(0, 122, 255, 0.0)');
            
            profitChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '利润',
                        data: data,
                        borderColor: '#007AFF',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: '#007AFF',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#000',
                            bodyColor: '#000',
                            borderColor: 'rgba(0, 0, 0, 0.1)',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return `利润: ${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: 'rgba(0, 0, 0, 0.6)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'rgba(0, 0, 0, 0.6)',
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 10
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // 初始化收入图表
        function initIncomeChart(labels, data) {
            const ctx = document.getElementById('incomeChart').getContext('2d');
            
            // 创建渐变背景
            const gradient = ctx.createLinearGradient(0, 0, 0, 250);
            gradient.addColorStop(0, 'rgba(52, 199, 89, 0.2)');
            gradient.addColorStop(1, 'rgba(52, 199, 89, 0.0)');
            
            incomeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '收入',
                        data: data,
                        borderColor: '#34C759',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: '#34C759',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#000',
                            bodyColor: '#000',
                            borderColor: 'rgba(0, 0, 0, 0.1)',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return `收入: ${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'rgba(0, 0, 0, 0.6)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'rgba(0, 0, 0, 0.6)',
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 10
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // 初始化费用图表
        function initExpenseChart(labels, data) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            // 创建渐变背景
            const gradient = ctx.createLinearGradient(0, 0, 0, 250);
            gradient.addColorStop(0, 'rgba(255, 59, 48, 0.2)');
            gradient.addColorStop(1, 'rgba(255, 59, 48, 0.0)');
            
            expenseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '费用',
                        data: data,
                        borderColor: '#FF3B30',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: '#FF3B30',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#000',
                            bodyColor: '#000',
                            borderColor: 'rgba(0, 0, 0, 0.1)',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return `费用: ${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'rgba(0, 0, 0, 0.6)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'rgba(0, 0, 0, 0.6)',
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 10
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
