<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <!-- PWA 必需标签 -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007AFF">

  <!-- iOS 额外支持 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="记账">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon.png">

  <!-- 安卓/通用 PWA 支持 -->
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- 添加Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  
  <!-- 添加SheetJS库用于Excel导出 -->
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  
  <!-- 添加Chart.js用于图表 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  
  <!-- 添加Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600&display=swap" rel="stylesheet">
  
  <title>每日记账</title>
  <style>
      :root {
          --primary-blue: #007AFF;
          --primary-red: #FF3B30;
          --primary-green: #34C759;
          --primary-orange: #FF9500;
          --system-gray-1: #F2F2F7;
          --system-gray-2: #E5E5EA;
          --system-gray-3: #D1D1D6;
          --system-gray-4: #8E8E93;
          --system-gray-5: #636366;
          --system-gray-6: #48484A;
          --white: #FFFFFF;
          --black: #000000;
      }
      
      body {
          font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
          background-color: var(--system-gray-1);
          color: var(--black);
          margin: 0;
          padding: 0;
          max-width: 100%;
          overflow-x: hidden;
          -webkit-tap-highlight-color: transparent;
          line-height: 1.5;
          padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      }
      
      .container {
          padding: 20px;
          max-width: 600px;
          margin: 0 auto;
          padding-bottom: 100px;
      }
      
      .header {
          font-size: 28px;
          font-weight: 600;
          margin-bottom: 24px;
          text-align: center;
          color: var(--black);
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      
      .logout-button, .details-button {
          background: none;
          border: none;
          cursor: pointer;
          padding: 8px;
          display: flex;
          align-items: center;
      }
      
      .logout-button:hover, .details-button:hover {
          background-color: var(--system-gray-2);
          border-radius: 50%;
      }

      /* 苹果风格登录界面 */
      .auth-card {
          background-color: rgba(255, 255, 255, 0.95);
          border-radius: 20px;
          padding: 32px 24px;
          margin: 40px 20px;
          box-shadow: 0 8px 30px rgba(0,0,0,0.12);
          max-width: 400px;
          margin-left: auto;
          margin-right: auto;
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
      }
      
      .auth-title {
          font-size: 28px;
          font-weight: 600;
          margin-bottom: 28px;
          text-align: center;
          color: var(--black);
          letter-spacing: -0.5px;
          background: linear-gradient(135deg, #007AFF, #5AC8FA);
          -webkit-background-clip: text;
          background-clip: text;
          -webkit-text-fill-color: transparent;
      }
      
      .auth-form {
          display: flex;
          flex-direction: column;
          gap: 20px;
      }
      
      .auth-input-group {
          position: relative;
      }
      
      .auth-input {
          padding: 16px;
          border: 1px solid rgba(0,0,0,0.05);
          border-radius: 12px;
          font-size: 16px;
          background-color: rgba(242, 242, 247, 0.6);
          transition: all 0.2s;
          width: 100%;
          box-sizing: border-box;
      }
      
      .auth-input:focus {
          outline: none;
          border-color: var(--primary-blue);
          background-color: rgba(242, 242, 247, 0.8);
          box-shadow: 0 0 0 2px rgba(0,122,255,0.1);
      }
      
      .auth-button {
          padding: 16px;
          border-radius: 12px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          border: none;
          transition: all 0.2s;
          width: 100%;
      }
      
      .login-button {
          background-color: var(--primary-blue);
          color: var(--white);
          margin-top: 16px;
          box-shadow: 0 4px 12px rgba(0,122,255,0.2);
      }
      
      .login-button:active {
          background-color: #0066CC;
          transform: scale(0.98);
          box-shadow: 0 2px 6px rgba(0,122,255,0.15);
      }
      
      .forgot-password {
          color: var(--primary-blue);
          font-size: 15px;
          text-align: center;
          margin-top: 20px;
          cursor: pointer;
          font-weight: 500;
      }
      
      .app-icon {
          width: 80px;
          height: 80px;
          margin: 0 auto 24px;
          background: linear-gradient(135deg, #007AFF, #5AC8FA);
          border-radius: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 8px 20px rgba(0,122,255,0.2);
      }
      
      /* 主应用内容 */
      .date-picker {
          margin-bottom: 20px;
          padding: 0;
          background: transparent;
          box-shadow: none;
          display: block;
          position: relative;
      }
      
      .ios-date-selector {
          background-color: rgba(255, 255, 255, 0.9);
          border-radius: 16px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          overflow: hidden;
          margin-bottom: 16px;
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
      }
      
      .date-display {
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 16px;
          border-bottom: 1px solid rgba(0,0,0,0.03);
          position: relative;
      }
      
      .date-display-text {
          font-size: 20px;
          font-weight: 600;
          color: var(--black);
      }
      
      .date-selector-controls {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 12px 16px;
      }
      
      .date-actions {
          display: flex;
          gap: 10px;
      }
      
      .date-action-button {
          background-color: rgba(242, 242, 247, 0.8);
          border: none;
          height: 36px;
          border-radius: 8px;
          font-size: 15px;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          color: var(--primary-blue);
          padding: 0 12px;
          transition: all 0.2s;
      }
      
      .date-action-button:active {
          background-color: rgba(0, 122, 255, 0.1);
          transform: scale(0.98);
      }
      
      .date-action-button svg {
          width: 16px;
          height: 16px;
      }
      
      .date-action-button#todayButton {
          background-color: var(--primary-blue);
          color: white;
      }
      
      .date-action-button#todayButton:active {
          background-color: #0066CC;
      }
      
      .hidden-date-input {
          position: absolute;
          top: 0;
          left: 0;
          width: 1px;
          height: 1px;
          opacity: 0;
          pointer-events: none;
      }
      
      /* 日期选择动画 */
      @keyframes date-selection-pulse {
          0% {
              background-color: rgba(0, 122, 255, 0.2);
          }
          100% {
              background-color: rgba(255, 255, 255, 0.9);
          }
      }
      
      .date-select-animation {
          animation: date-selection-pulse 0.6s ease;
      }
      
      .summary-card {
          background-color: var(--white);
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 20px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      }
      
      .summary-title {
          font-size: 17px;
          color: var(--system-gray-4);
          margin-bottom: 16px;
          text-align: center;
          font-weight: 500;
      }
      
      .summary-items {
          display: flex;
          justify-content: space-between;
          gap: 12px;
      }
      
      .summary-item {
          flex: 1;
          text-align: center;
          padding: 12px;
          border-radius: 8px;
          background-color: var(--system-gray-1);
      }
      
      .summary-item-title {
          font-size: 14px;
          color: var(--system-gray-4);
          margin-bottom: 6px;
      }
      
      .summary-item-value {
          font-size: 20px;
          font-weight: 600;
      }
      
      .records-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
      }
      
      .records-title {
          font-size: 17px;
          color: var(--system-gray-4);
          font-weight: 500;
      }
      
      .export-dropdown {
          position: relative;
          display: inline-block;
      }
      
      .export-button {
          padding: 8px 16px;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
          border: 1px solid var(--system-gray-2);
          background-color: var(--white);
          color: var(--primary-blue);
          transition: all 0.2s;
          display: flex;
          align-items: center;
          gap: 6px;
      }
      
      .export-button:hover {
          background-color: var(--system-gray-1);
      }
      
      .dropdown-content {
          display: none;
          position: absolute;
          right: 0;
          background-color: var(--white);
          min-width: 120px;
          box-shadow: 0 8px 16px rgba(0,0,0,0.1);
          border-radius: 8px;
          z-index: 1;
          overflow: hidden;
      }
      
      .dropdown-content a {
          color: var(--system-gray-6);
          padding: 12px 16px;
          text-decoration: none;
          display: block;
          font-size: 14px;
          transition: background-color 0.2s;
      }
      
      .dropdown-content a:hover {
          background-color: var(--system-gray-1);
      }
      
      .export-dropdown:hover .dropdown-content {
          display: block;
      }
      
      .records-list {
          background-color: var(--white);
          border-radius: 12px;
          overflow: hidden;
          margin-bottom: 20px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      }
      
      .record-item {
          padding: 16px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-bottom: 1px solid var(--system-gray-1);
      }
      
      .record-item:last-child {
          border-bottom: none;
      }
      
      .record-type {
          font-size: 16px;
          flex: 1;
      }
      
      .record-amount.income {
          color: var(--primary-green);
          font-weight: 500;
      }
      
      .record-amount.expense {
          color: var(--primary-red);
          font-weight: 500;
      }
      
      .no-records {
          text-align: center;
          color: var(--system-gray-4);
          padding: 24px;
          font-size: 16px;
      }
      
      /* 改进添加按钮样式 */
      .add-button {
          position: fixed;
          bottom: calc(24px + env(safe-area-inset-bottom));
          right: 24px;
          width: 60px;
          height: 60px;
          background: linear-gradient(135deg, var(--primary-blue), #0066CC);
          color: var(--white);
          border-radius: 30px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 28px;
          box-shadow: 0 4px 16px rgba(0,122,255,0.3);
          border: none;
          cursor: pointer;
          z-index: 10;
          transition: all 0.25s cubic-bezier(0.25, 1, 0.5, 1);
      }
      
      .add-button:active {
          transform: scale(0.95);
          box-shadow: 0 2px 8px rgba(0,122,255,0.2);
      }
      
      /* iOS风格模态框 */
      .modal {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: rgba(0,0,0,0.4);
          backdrop-filter: blur(12px);
          -webkit-backdrop-filter: blur(12px);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 100;
          display: none;
          padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      }
      
      .modal-content {
          background-color: rgba(255, 255, 255, 0.96);
          width: calc(100% - 40px);
          max-width: 400px;
          border-radius: 20px;
          overflow: hidden;
          animation: modal-appear 0.3s cubic-bezier(0.25, 1, 0.5, 1);
          margin: auto;
          box-shadow: 0 8px 40px rgba(0,0,0,0.18);
      }
      
      .modal-header {
          padding: 18px 20px;
          font-size: 20px;
          font-weight: 600;
          border-bottom: 1px solid rgba(0,0,0,0.05);
          display: flex;
          justify-content: space-between;
          align-items: center;
          color: var(--black);
      }
      
      .modal-body {
          padding: 24px;
      }
      
      .form-group {
          margin-bottom: 24px;
      }
      
      .form-group label {
          display: block;
          margin-bottom: 12px;
          color: var(--system-gray-5);
          font-size: 15px;
          font-weight: 500;
      }
      
      .form-group input {
          width: 100%;
          padding: 16px;
          border: 1px solid rgba(0,0,0,0.05);
          border-radius: 12px;
          font-size: 16px;
          background-color: rgba(242, 242, 247, 0.6);
          transition: all 0.2s;
      }
      
      .form-group input:focus {
          outline: none;
          border-color: var(--primary-blue);
          background-color: rgba(242, 242, 247, 0.8);
          box-shadow: 0 0 0 2px rgba(0,122,255,0.1);
      }
      
      .type-options {
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
      }
      
      .type-option {
          padding: 12px 16px;
          border: 1px solid rgba(0,0,0,0.05);
          border-radius: 12px;
          font-size: 15px;
          cursor: pointer;
          background-color: rgba(242, 242, 247, 0.6);
          transition: all 0.2s;
      }
      
      .type-option.selected {
          background-color: var(--primary-blue);
          color: var(--white);
          border-color: var(--primary-blue);
          font-weight: 500;
          box-shadow: 0 2px 8px rgba(0,122,255,0.2);
      }
      
      .type-option:active {
          transform: scale(0.98);
          background-color: rgba(242, 242, 247, 0.8);
      }
      
      .modal-footer {
          display: flex;
          justify-content: flex-end;
          padding: 16px 20px 20px;
          border-top: 1px solid rgba(0,0,0,0.03);
          gap: 12px;
      }
      
      .btn {
          padding: 14px 22px;
          border-radius: 12px;
          font-size: 16px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.2s;
          border: none;
      }
      
      .btn-cancel {
          background-color: rgba(242, 242, 247, 0.8);
          color: var(--system-gray-6);
      }
      
      .btn-cancel:active {
          background-color: rgba(242, 242, 247, 0.9);
          transform: scale(0.98);
      }
      
      .btn-save {
          background-color: var(--primary-blue);
          color: var(--white);
          box-shadow: 0 2px 8px rgba(0,122,255,0.2);
      }
      
      .btn-save:active {
          background-color: #0066CC;
          transform: scale(0.98);
          box-shadow: 0 1px 4px rgba(0,122,255,0.15);
      }
      
      /* 详细数据模态框改进 */
      .details-modal-content {
          max-width: 600px;
          width: calc(100% - 40px);
          max-height: 85vh;
          overflow-y: auto;
          border-radius: 20px;
          background-color: rgba(255, 255, 255, 0.96);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          box-shadow: 0 10px 40px rgba(0,0,0,0.18);
      }
      
      .summary-stats {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 15px;
          margin: 24px 0;
          padding: 0 24px;
      }
      
      .stat-card {
          flex: 1;
          padding: 20px 16px;
          background-color: rgba(250, 250, 250, 0.8);
          border-radius: 16px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.03);
          display: flex;
          flex-direction: column;
          align-items: center;
          backdrop-filter: blur(5px);
          -webkit-backdrop-filter: blur(5px);
      }
      
      .stat-label {
          font-size: 14px;
          color: var(--system-gray-4);
          margin-bottom: 8px;
          font-weight: 500;
      }
      
      .stat-value {
          font-size: 26px;
          font-weight: 600;
      }
      
      .stat-value.income {
          color: var(--primary-green);
      }
      
      .stat-value.expense {
          color: var(--primary-red);
      }
      
      .stat-value.profit {
          color: var(--primary-blue);
      }
      
      .date-range-selector {
          background-color: rgba(250, 250, 250, 0.8);
          border-radius: 16px;
          margin: 0 20px 24px;
          padding: 18px;
          box-shadow: 0 1px 5px rgba(0,0,0,0.03);
          backdrop-filter: blur(5px);
          -webkit-backdrop-filter: blur(5px);
      }
      
      .date-range-title {
          font-size: 16px;
          font-weight: 600;
          color: var(--system-gray-5);
          margin-bottom: 16px;
          text-align: center;
      }
      
      .date-range-buttons {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 10px;
          margin-bottom: 16px;
      }
      
      .range-preset-button {
          padding: 10px 8px;
          background-color: rgba(240, 240, 245, 0.8);
          border: none;
          border-radius: 12px;
          font-size: 14px;
          font-weight: 500;
          color: var(--primary-blue);
          cursor: pointer;
          transition: all 0.2s;
          text-align: center;
      }
      
      .range-preset-button:active,
      .range-preset-button.active {
          background-color: var(--primary-blue);
          color: var(--white);
          transform: scale(0.98);
      }
      
      .custom-range-inputs {
          display: flex;
          gap: 10px;
          margin-bottom: 18px;
      }
      
      .date-input-wrapper {
          position: relative;
          flex: 1;
      }
      
      .date-range-input {
          width: 100%;
          padding: 12px 14px;
          border: 1px solid rgba(0,0,0,0.05);
          border-radius: 12px;
          font-size: 15px;
          background-color: rgba(240, 240, 245, 0.6);
          transition: all 0.2s;
      }
      
      .date-range-input:focus {
          outline: none;
          border-color: var(--primary-blue);
          background-color: rgba(240, 240, 245, 0.8);
          box-shadow: 0 0 0 2px rgba(0,122,255,0.1);
      }
      
      .date-input-label {
          position: absolute;
          top: -8px;
          left: 12px;
          font-size: 12px;
          font-weight: 500;
          color: var(--system-gray-4);
          background-color: rgba(240, 240, 245, 0.8);
          padding: 0 4px;
          border-radius: 4px;
      }
      
      .apply-dates-button {
          width: 100%;
          background-color: var(--primary-blue);
          color: var(--white);
          padding: 12px;
          border-radius: 12px;
          font-size: 16px;
          font-weight: 500;
          cursor: pointer;
          border: none;
          transition: all 0.25s cubic-bezier(0.25, 1, 0.5, 1);
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      }
      
      .apply-dates-button:active {
          transform: scale(0.98);
          background-color: #0066CC;
      }
      
      .chart-container {
          margin: 0 20px 24px;
          background-color: rgba(250, 250, 250, 0.8);
          border-radius: 16px;
          padding: 16px;
          box-shadow: 0 1px 5px rgba(0,0,0,0.03);
          backdrop-filter: blur(5px);
          -webkit-backdrop-filter: blur(5px);
      }
      
      .chart-title {
          font-size: 16px;
          font-weight: 600;
          color: var(--system-gray-5);
          margin-bottom: 16px;
          text-align: center;
      }
      
      .chart-wrapper {
          height: 200px;
          width: 100%;
      }
      
      /* 优化关闭按钮 */
      .ios-header-button {
          background-color: rgba(240, 240, 245, 0.6);
          border: none;
          padding: 8px 16px;
          font-size: 15px;
          font-weight: 500;
          color: var(--primary-blue);
          cursor: pointer;
          transition: all 0.2s;
          border-radius: 12px;
      }
      
      .ios-header-button:active {
          background-color: rgba(0,122,255,0.1);
          transform: scale(0.98);
      }
      
      /* 密码重置模态框 */
      .reset-modal-content {
          background-color: var(--white);
          width: calc(100% - 40px);
          max-width: 400px;
          border-radius: 12px;
          overflow: hidden;
          margin: auto;
      }
      
      .reset-instructions {
          font-size: 14px;
          color: var(--system-gray-4);
          margin-top: 8px;
      }
      
      /* 响应式调整 */
      @media (max-width: 400px) {
          .summary-items {
              flex-direction: column;
              gap: 12px;
          }
          .range-picker {
              flex-direction: column;
          }
      }

      /* 添加离线通知样式 */
      .offline-notice {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          background-color: rgba(255, 149, 0, 0.95);
          color: white;
          text-align: center;
          padding: 10px 20px;
          font-size: 14px;
          font-weight: 500;
          z-index: 1000;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
      }

      .offline-notice.show {
          display: block;
          animation: slideDown 0.3s forwards;
      }

      @keyframes slideDown {
          from {
              transform: translateY(-100%);
          }
          to {
              transform: translateY(0);
          }
      }

      /* 修改详细数据按钮样式 */
      .details-button {
          background: none;
          border: none;
          cursor: pointer;
          padding: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          color: var(--system-gray-6);
          transition: all 0.2s;
          border-radius: 50%;
          width: 38px;
          height: 38px;
      }

      .details-button:active {
          background-color: rgba(0,0,0,0.05);
          transform: scale(0.95);
      }

      .date-button.date-selected {
          animation: date-pulse 0.5s ease;
      }

      @keyframes date-pulse {
          0% {
              background-color: rgba(0, 122, 255, 0.2);
              box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.4);
          }
          70% {
              background-color: rgba(0, 122, 255, 0.1);
              box-shadow: 0 0 0 1px rgba(0, 122, 255, 0.2);
          }
          100% {
              background-color: rgba(255, 255, 255, 0.9);
              box-shadow: 0 1px 5px rgba(0,0,0,0.03);
          }
      }

      /* iOS风格加载指示器 */
      .loader {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: rgba(255, 255, 255, 0.96);
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
          z-index: 9999;
          display: none;
          justify-content: center;
          align-items: center;
      }

      .loader-content {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 20px;
      }

      .loader-spinner {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          border: 3px solid rgba(0, 122, 255, 0.2);
          border-top-color: var(--primary-blue);
          animation: spin 1s infinite linear;
      }

      .loader-text {
          color: var(--system-gray-5);
          font-size: 16px;
          font-weight: 500;
      }

      @keyframes spin {
          to {
              transform: rotate(360deg);
          }
      }

      /* 日期选择效果 */
      .date-selected {
          animation: date-selected-pulse 0.5s ease;
      }

      @keyframes date-selected-pulse {
          0% {
              background-color: rgba(0, 122, 255, 0.2);
          }
          70% {
              background-color: rgba(0, 122, 255, 0.1);
          }
          100% {
              background-color: transparent;
          }
      }
  </style>
</head>
<body>
    <!-- 加载指示器 -->
    <div class="loader" id="loader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <p class="loader-text" id="loaderText">数据加载中...</p>
        </div>
    </div>
    
    <!-- 离线提示 -->
    <div class="offline-notice" id="offlineNotice">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
            <path d="M12 16V16.01M12 8V12M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        您当前处于离线状态，可以查看最近数据
    </div>
    
    <div class="container">
        <!-- 认证部分 -->
        <div id="authSection">
            <div class="auth-card">
                <div class="app-icon">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 6.5H10M3 12H16M3 17.5H21" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h2 class="auth-title">每日记账</h2>
                <div id="loginForm" class="auth-form">
                    <div class="auth-input-group">
                        <input type="email" id="email" class="auth-input" placeholder="电子邮箱">
                    </div>
                    <div class="auth-input-group">
                        <input type="password" id="password" class="auth-input" placeholder="密码">
                    </div>
                    <button id="loginButton" class="auth-button login-button">登录</button>
                    <div class="forgot-password" id="forgotPassword">忘记密码？</div>
                    <div id="authError" class="error-message" style="color: var(--primary-red); text-align: center; font-size: 14px; margin-top: 12px;"></div>
                </div>
            </div>
        </div>
        
        <!-- 主应用内容 (默认隐藏，登录后显示) -->
        <div id="appContent" style="display: none;">
            <div class="header">
                <button class="details-button" id="detailsButton" title="详细数据">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 7H21M3 12H21M3 17H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
                <span>每日记账</span>
                <button class="logout-button" id="logoutButton" title="退出登录">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9M16 17L21 12M21 12L16 7M21 12H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            
            <div class="date-picker">
                <div class="ios-date-selector">
                    <div class="date-display">
                        <div class="date-display-text" id="dateDisplay"></div>
                    </div>
                    <div class="date-selector-controls">
                        <div class="date-actions">
                            <button class="date-action-button" id="prevDayButton" title="前一天">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M15 6L9 12L15 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                            <button class="date-action-button" id="todayButton">今天</button>
                            <button class="date-action-button" id="nextDayButton" title="后一天">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M9 6L15 12L9 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                        <button class="date-action-button" id="dateButton">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--primary-blue);">
                                <path d="M8 7V3M16 7V3M3 11H21M5 5H19C20.1046 5 21 5.89543 21 7V19C21 20.1046 20.1046 21 19 21H5C3.89543 21 3 20.1046 3 19V7C3 5.89543 3.89543 5 5 5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <input type="date" id="datePicker" class="hidden-date-input">
            </div>
            
            <div class="summary-card">
                <div class="summary-title">概览</div>
                <div class="summary-items">
                    <div class="summary-item">
                        <div class="summary-item-title">收入</div>
                        <div class="summary-item-value" id="incomeTotal">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-item-title">费用</div>
                        <div class="summary-item-value" id="expenseTotal">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-item-title">利润</div>
                        <div class="summary-item-value" id="profitTotal">0.00</div>
                    </div>
                </div>
            </div>
            
            <div class="records-header">
                <div class="records-title">记录</div>
                <div class="export-dropdown">
                    <button class="export-button">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 3V16M12 16L16 12M12 16L8 12M6 20H18C19.1046 20 20 19.1046 20 18V6C20 4.89543 19.1046 4 18 4H6C4.89543 4 4 4.89543 4 6V18C4 19.1046 4.89543 20 6 20Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        导出
                    </button>
                    <div class="dropdown-content">
                        <a href="#" id="exportCsv">导出为CSV</a>
                        <a href="#" id="exportExcel">导出为Excel</a>
                    </div>
                </div>
            </div>
            <div class="records-list" id="recordsList">
                <div class="no-records">暂无记录</div>
            </div>
            
            <button class="add-button" id="addButton">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 6V12M12 12V18M12 12H18M12 12H6" stroke="white" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            
            <!-- 添加记录模态框 -->
            <div class="modal" id="addModal">
                <div class="modal-content">
                    <div class="modal-header">添加记录</div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="amount">金额</label>
                            <input type="number" id="amount" placeholder="输入金额" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>类型</label>
                            <div class="type-options" id="typeOptions">
                                <div class="type-option" data-type="收入-吃喝岭师">收入-吃喝岭师</div>
                                <div class="type-option" data-type="收入-24个半">收入-24个半</div>
                                <div class="type-option" data-type="费用-食材">费用-食材</div>
                                <div class="type-option" data-type="费用-交通">费用-交通</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-cancel" id="cancelBtn">取消</button>
                        <button class="btn btn-save" id="saveBtn">保存</button>
                    </div>
                </div>
            </div>
            
            <!-- 详细数据模态框 -->
            <div class="modal" id="detailsModal">
                <div class="details-modal-content">
                    <div class="modal-header">
                        <span>详细数据</span>
                        <button class="ios-header-button" id="detailsCloseBtn">关闭</button>
                    </div>
                    <div class="modal-body">
                        <div class="summary-stats">
                            <div class="stat-card">
                                <div class="stat-label">总收入</div>
                                <div class="stat-value income" id="totalIncome">0.00</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">总费用</div>
                                <div class="stat-value expense" id="totalExpense">0.00</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">总利润</div>
                                <div class="stat-value profit" id="totalProfit">0.00</div>
                            </div>
                        </div>
                        
                        <div class="date-range-selector">
                            <div class="date-range-title">选择时间范围</div>
                            <div class="date-range-buttons">
                                <button class="range-preset-button" data-days="7">最近7天</button>
                                <button class="range-preset-button" data-days="30">最近30天</button>
                                <button class="range-preset-button" data-days="90">最近90天</button>
                                <button class="range-preset-button" data-range="month">本月</button>
                                <button class="range-preset-button" data-range="last-month">上月</button>
                                <button class="range-preset-button" data-range="year">今年</button>
                            </div>
                            <div class="custom-range-inputs">
                                <div class="date-input-wrapper">
                                    <span class="date-input-label">开始日期</span>
                                    <input type="date" id="startDate" class="date-range-input" placeholder="开始日期">
                                </div>
                                <div class="date-input-wrapper">
                                    <span class="date-input-label">结束日期</span>
                                    <input type="date" id="endDate" class="date-range-input" placeholder="结束日期">
                                </div>
                            </div>
                            <button id="applyDatesBtn" class="apply-dates-button">应用</button>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">利润趋势</div>
                            <div class="chart-wrapper">
                                <canvas id="profitChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">收入趋势</div>
                            <div class="chart-wrapper">
                                <canvas id="incomeChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">费用趋势</div>
                            <div class="chart-wrapper">
                                <canvas id="expenseChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 密码重置模态框 -->
    <div class="modal" id="resetModal">
        <div class="reset-modal-content">
            <div class="modal-header">重置密码</div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="resetEmail">电子邮箱</label>
                    <input type="email" id="resetEmail" placeholder="输入您的注册邮箱">
                    <p class="reset-instructions">我们将发送密码重置链接到您的邮箱</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" id="resetCancelBtn">取消</button>
                <button class="btn btn-save" id="resetSubmitBtn">发送</button>
            </div>
        </div>
    </div>

    <script>
        // 数据结构
        class Record {
            constructor(amount, type, date) {
                this.id = Date.now().toString();
                this.amount = parseFloat(amount);
                this.type = type;
                this.date = date;
            }
        }

        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDYY_Cex21vcQGR9beUvOniHxNeRqbpr6k",
            authDomain: "jizhang-e867a.firebaseapp.com",
            databaseURL: "https://jizhang-e867a-default-rtdb.firebaseio.com",
            projectId: "jizhang-e867a",
            storageBucket: "jizhang-e867a.appspot.com",
            messagingSenderId: "879272417495",
            appId: "1:879272417495:web:11ff018db63c50c3ccf892",
            measurementId: "G-4R1MKP7G6S"
        };

        // 初始化Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // 启用离线持久化
        database.goOnline();
        
        // 应用状态
        let records = [];
        let selectedDate = new Date().toISOString().split('T')[0];
        let currentUser = null;
        let isOnline = navigator.onLine;
        let selectedType = null;
        let profitChart, incomeChart, expenseChart;

        // DOM元素
        const datePicker = document.getElementById('datePicker');
        const dateButton = document.getElementById('dateButton');
        const dateDisplay = document.getElementById('dateDisplay');
        const incomeTotal = document.getElementById('incomeTotal');
        const expenseTotal = document.getElementById('expenseTotal');
        const profitTotal = document.getElementById('profitTotal');
        const recordsList = document.getElementById('recordsList');
        const addButton = document.getElementById('addButton');
        const addModal = document.getElementById('addModal');
        const amountInput = document.getElementById('amount');
        const typeOptions = document.getElementById('typeOptions');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveBtn = document.getElementById('saveBtn');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        const authSection = document.getElementById('authSection');
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authError = document.getElementById('authError');
        const appContent = document.getElementById('appContent');
        const exportCsvBtn = document.getElementById('exportCsv');
        const exportExcelBtn = document.getElementById('exportExcel');
        const forgotPassword = document.getElementById('forgotPassword');
        const resetModal = document.getElementById('resetModal');
        const resetEmail = document.getElementById('resetEmail');
        const resetCancelBtn = document.getElementById('resetCancelBtn');
        const resetSubmitBtn = document.getElementById('resetSubmitBtn');
        const offlineNotice = document.getElementById('offlineNotice');
        const logoutButton = document.getElementById('logoutButton');
        const detailsButton = document.getElementById('detailsButton');
        const detailsModal = document.getElementById('detailsModal');
        const detailsCloseBtn = document.getElementById('detailsCloseBtn');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const detailsExportCsvBtn = document.getElementById('detailsExportCsv');
        const detailsExportExcelBtn = document.getElementById('detailsExportExcel');

        // 显示/隐藏加载指示器
        function showLoader(show, text = "数据加载中...") {
            loaderText.textContent = text;
            loader.style.display = show ? 'flex' : 'none';
        }

        // 更新网络状态
        function updateNetworkStatus() {
            isOnline = navigator.onLine;
            if (isOnline) {
                offlineNotice.classList.remove('show');
                if (currentUser) {
                    syncPendingChanges();
                }
            } else {
                offlineNotice.classList.add('show');
            }
        }

        // 同步离线时的更改
        async function syncPendingChanges() {
            const pendingChanges = JSON.parse(localStorage.getItem('pendingChanges')) || [];
            if (pendingChanges.length === 0) return;
            
            showLoader(true, "正在同步离线更改...");
            
            try {
                for (const change of pendingChanges) {
                    if (change.type === 'add') {
                        await database.ref(`users/${currentUser.uid}/records/${change.data.id}`).set(change.data);
                    } else if (change.type === 'delete') {
                        await database.ref(`users/${currentUser.uid}/records/${change.id}`).remove();
                    }
                }
                
                localStorage.removeItem('pendingChanges');
                await loadRecordsFromFirebase();
                updateUI();
                updateDetailsCharts();
            } catch (error) {
                console.error("同步失败:", error);
            } finally {
                showLoader(false);
            }
        }

        // 初始化
        async function init() {
            showLoader(true);
            datePicker.value = selectedDate;
            dateDisplay.textContent = formatDate(selectedDate);
            
            // 修改日期选择器实现
            document.getElementById('dateButton').addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // 显示日期选择动画效果
                const dateDisplay = document.querySelector('.date-display');
                dateDisplay.classList.add('date-select-animation');
                
                // 触发原生日期选择器
                datePicker.click();
                
                // 监听日期变化来移除选择状态
                datePicker.addEventListener('change', () => {
                    dateDisplay.classList.remove('date-select-animation');
                }, { once: true });
                
                // 点击其他地方时移除选择状态
                setTimeout(() => {
                    const clickHandler = () => {
                        dateDisplay.classList.remove('date-select-animation');
                        document.removeEventListener('click', clickHandler);
                    };
                    document.addEventListener('click', clickHandler);
                }, 100);
            });
            
            // 日期导航按钮实现
            document.getElementById('prevDayButton').addEventListener('click', () => {
                navigateDate(-1);
            });
            
            document.getElementById('nextDayButton').addEventListener('click', () => {
                navigateDate(1);
            });
            
            document.getElementById('todayButton').addEventListener('click', () => {
                const today = new Date().toISOString().split('T')[0];
                selectedDate = today;
                datePicker.value = today;
                dateDisplay.textContent = formatDate(today);
                updateUI();
            });
            
            datePicker.addEventListener('change', (e) => {
                selectedDate = e.target.value;
                document.querySelector('.date-display-text').textContent = formatDate(selectedDate);
                
                // 添加选择确认的视觉效果
                const dateDisplay = document.querySelector('.date-display');
                dateDisplay.classList.add('date-selected');
                setTimeout(() => {
                    dateDisplay.classList.remove('date-selected');
                }, 500);
                
                updateUI();
            });
            
            // 初始化详细数据中的日期范围预设按钮
            const rangeButtons = document.querySelectorAll('.range-preset-button');
            rangeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // 移除所有按钮的active类
                    rangeButtons.forEach(btn => btn.classList.remove('active'));
                    // 给当前按钮添加active类
                    button.classList.add('active');
                    
                    const days = button.dataset.days;
                    const range = button.dataset.range;
                    
                    const endDate = new Date();
                    let startDate = new Date();
                    
                    if (days) {
                        // 如果是基于天数的预设
                        startDate.setDate(endDate.getDate() - parseInt(days));
                    } else if (range) {
                        // 如果是基于特定范围的预设
                        if (range === 'month') {
                            // 本月
                            startDate = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
                        } else if (range === 'last-month') {
                            // 上月
                            startDate = new Date(endDate.getFullYear(), endDate.getMonth() - 1, 1);
                            endDate = new Date(endDate.getFullYear(), endDate.getMonth(), 0);
                        } else if (range === 'year') {
                            // 今年
                            startDate = new Date(endDate.getFullYear(), 0, 1);
                        }
                    }
                    
                    // 更新日期输入框
                    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
                    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
                });
            });
            
            // 日期范围输入框变更事件
            document.getElementById('startDate').addEventListener('change', () => {
                // 移除所有预设按钮的active类
                rangeButtons.forEach(btn => btn.classList.remove('active'));
            });
            
            document.getElementById('endDate').addEventListener('change', () => {
                // 移除所有预设按钮的active类
                rangeButtons.forEach(btn => btn.classList.remove('active'));
            });
            
            // 应用日期筛选按钮
            document.getElementById('applyDatesBtn').addEventListener('click', updateDetailsCharts);
            
            // 检查自动登录
            await checkAutoLogin();
            
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
            updateNetworkStatus();
            
            // 优化认证状态监听
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    loginForm.style.display = 'none';
                    authSection.style.display = 'none';
                    appContent.style.display = 'block';
                    
                    try {
                        // 并行加载数据
                        await Promise.all([
                            loadRecordsFromFirebase(),
                            new Promise(resolve => setTimeout(resolve, 100)) // 添加小延迟确保UI更新
                        ]);
                        updateUI();
                    } catch (error) {
                        console.error("加载数据失败:", error);
                        authError.textContent = "加载数据失败，请重试";
                    }
                } else {
                    currentUser = null;
                    loginForm.style.display = 'block';
                    authSection.style.display = 'block';
                    appContent.style.display = 'none';
                    records = [];
                }
                showLoader(false);
            });
            
            addButton.addEventListener('click', () => {
                if (!currentUser) return;
                addModal.style.display = 'flex';
                amountInput.focus();
                selectedType = null;
                updateTypeSelection();
            });
            
            cancelBtn.addEventListener('click', () => {
                addModal.style.display = 'none';
                amountInput.value = '';
                selectedType = null;
            });
            
            saveBtn.addEventListener('click', saveRecord);
            
            loginButton.addEventListener('click', handleLogin);
            
            logoutButton.addEventListener('click', handleLogout);
            
            exportCsvBtn.addEventListener('click', exportToCsv);
            exportExcelBtn.addEventListener('click', exportToExcel);
            
            forgotPassword.addEventListener('click', () => {
                resetModal.style.display = 'flex';
                resetEmail.value = emailInput.value || '';
                resetEmail.focus();
            });
            
            resetCancelBtn.addEventListener('click', () => {
                resetModal.style.display = 'none';
                resetEmail.value = '';
            });
            
            resetSubmitBtn.addEventListener('click', handlePasswordReset);
            
            typeOptions.addEventListener('click', (e) => {
                const option = e.target.closest('.type-option');
                if (option) {
                    selectedType = option.dataset.type;
                    updateTypeSelection();
                }
            });
            
            addModal.addEventListener('click', (e) => {
                if (e.target === addModal) {
                    addModal.style.display = 'none';
                    amountInput.value = '';
                    selectedType = null;
                }
            });
            
            resetModal.addEventListener('click', (e) => {
                if (e.target === resetModal) {
                    resetModal.style.display = 'none';
                    resetEmail.value = '';
                }
            });

            detailsButton.addEventListener('click', () => {
                detailsModal.style.display = 'flex';
                initCharts();
                updateDetailsCharts();
            });

            detailsCloseBtn.addEventListener('click', () => {
                detailsModal.style.display = 'none';
            });

            detailsModal.addEventListener('click', (e) => {
                if (e.target === detailsModal) {
                    detailsModal.style.display = 'none';
                }
            });

            startDateInput.addEventListener('change', updateDetailsCharts);
            endDateInput.addEventListener('change', updateDetailsCharts);

            detailsExportCsvBtn.addEventListener('click', exportDetailsToCsv);
            detailsExportExcelBtn.addEventListener('click', exportDetailsToExcel);

            amountInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveRecord();
                }
            });
            
            resetEmail.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handlePasswordReset();
                }
            });

            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
                document.body.classList.add('standalone');
            }
        }

        // 格式化日期显示
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // 更新类型选择状态
        function updateTypeSelection() {
            const options = typeOptions.querySelectorAll('.type-option');
            options.forEach(option => {
                if (option.dataset.type === selectedType) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        // 处理退出登录
        async function handleLogout() {
            try {
                showLoader(true, "正在退出...");
                await auth.signOut();
            } catch (error) {
                console.error("退出失败:", error);
                authError.textContent = "退出失败，请重试";
            } finally {
                showLoader(false);
            }
        }

        // 处理登录/注册
        async function handleLogin() {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!email || !password) {
                authError.textContent = "请输入邮箱和密码";
                return;
            }
            
            showLoader(true, "正在登录...");
            authError.textContent = "";
            
            try {
                // 设置登录超时
                const loginPromise = auth.signInWithEmailAndPassword(email, password);
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('登录超时')), 5000)
                );
                
                await Promise.race([loginPromise, timeoutPromise]);
                
                // 登录成功后保存信息
                localStorage.setItem('userEmail', email);
                localStorage.setItem('userPassword', password);
            } catch (loginError) {
                console.error("登录错误:", loginError);
                
                if (loginError.code === 'auth/user-not-found') {
                    try {
                        await auth.createUserWithEmailAndPassword(email, password);
                        localStorage.setItem('userEmail', email);
                        localStorage.setItem('userPassword', password);
                        authError.textContent = "注册成功，已自动登录";
                    } catch (signupError) {
                        console.error("注册错误:", signupError);
                        authError.textContent = getAuthErrorMessage(signupError);
                    }
                } else {
                    authError.textContent = getAuthErrorMessage(loginError);
                }
            } finally {
                showLoader(false);
            }
        }

        // 处理密码重置
        async function handlePasswordReset() {
            const email = resetEmail.value.trim();
            
            if (!email) {
                authError.textContent = "请输入注册邮箱";
                return;
            }
            
            showLoader(true, "正在发送重置邮件...");
            
            try {
                await auth.sendPasswordResetEmail(email);
                resetModal.style.display = 'none';
                resetEmail.value = '';
                authError.textContent = "密码重置邮件已发送，请检查您的邮箱";
            } catch (error) {
                console.error("密码重置错误:", error);
                authError.textContent = getAuthErrorMessage(error);
            } finally {
                showLoader(false);
            }
        }

        // 获取认证错误信息
        function getAuthErrorMessage(error) {
            const errorMap = {
                'auth/invalid-email': '邮箱格式不正确，请检查',
                'auth/user-disabled': '账户已被禁用，请联系管理员',
                'auth/user-not-found': '账户不存在，将尝试注册',
                'auth/wrong-password': '密码错误，请重试',
                'auth/email-already-in-use': '邮箱已被注册，请直接登录',
                'auth/weak-password': '密码强度不足(至少6个字符)',
                'auth/operation-not-allowed': '未启用邮箱/密码登录，请检查Firebase配置',
                'auth/too-many-requests': '尝试次数过多，请稍后再试',
                'auth/network-request-failed': '网络连接失败，请检查网络',
                'auth/missing-email': '请输入邮箱地址'
            };
            
            return errorMap[error.code] || `操作失败: ${error.message}`;
        }

        // 从Firebase加载数据
        async function loadRecordsFromFirebase() {
            if (!currentUser) return;
            
            return new Promise((resolve, reject) => {
                database.ref(`users/${currentUser.uid}/records`).once('value')
                    .then((snapshot) => {
                        const data = snapshot.val();
                        records = data ? Object.values(data) : [];
                        records.sort((a, b) => new Date(b.date) - new Date(a.date));
                        resolve();
                    })
                    .catch((error) => {
                        reject(error);
                    });
            });
        }

        // 更新主界面UI
        function updateUI() {
            const filteredRecords = records.filter(record => record.date === selectedDate);
            
            const dailyIncome = filteredRecords
                .filter(record => record.type.startsWith('收入'))
                .reduce((sum, record) => sum + record.amount, 0);
                
            const dailyExpense = filteredRecords
                .filter(record => record.type.startsWith('费用'))
                .reduce((sum, record) => sum + record.amount, 0);
                
            const dailyProfit = dailyIncome - dailyExpense;
            
            incomeTotal.textContent = dailyIncome.toFixed(2);
            expenseTotal.textContent = dailyExpense.toFixed(2);
            profitTotal.textContent = dailyProfit.toFixed(2);
            
            profitTotal.style.color = dailyProfit >= 0 ? 'var(--primary-green)' : 'var(--primary-red)';
            
            renderRecords(filteredRecords);
        }

        // 渲染记录列表
        function renderRecords(recordsToRender) {
            if (recordsToRender.length === 0) {
                recordsList.innerHTML = '<div class="no-records">暂无记录</div>';
                return;
            }
            
            let html = '';
            recordsToRender.forEach(record => {
                const isIncome = record.type.startsWith('收入');
                html += `
                    <div class="record-item" data-id="${record.id}">
                        <span class="record-type">${record.type}</span>
                        <span class="record-amount ${isIncome ? 'income' : 'expense'}">${record.amount.toFixed(2)}</span>
                        <button class="delete-btn" onclick="deleteRecord('${record.id}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                `;
            });
            
            recordsList.innerHTML = html;
        }

        // 保存记录
        async function saveRecord() {
            if (!currentUser) return;
            
            const amount = amountInput.value.trim();
            
            if (!amount || isNaN(amount)) {
                alert('请输入有效的金额');
                return;
            }
            
            if (!selectedType) {
                alert('请选择记录类型');
                return;
            }
            
            const newRecord = new Record(amount, selectedType, selectedDate);
            
            try {
                showLoader(true, "正在保存...");
                
                if (isOnline) {
                    await database.ref(`users/${currentUser.uid}/records/${newRecord.id}`).set(newRecord);
                } else {
                    const pendingChanges = JSON.parse(localStorage.getItem('pendingChanges')) || [];
                    pendingChanges.push({
                        type: 'add',
                        data: newRecord
                    });
                    localStorage.setItem('pendingChanges', JSON.stringify(pendingChanges));
                }
                
                records.push(newRecord);
                
                amountInput.value = '';
                selectedType = null;
                addModal.style.display = 'none';
                updateUI();
                updateDetailsCharts();
            } catch (error) {
                console.error("保存失败:", error);
                alert('保存失败，请检查网络连接');
            } finally {
                showLoader(false);
            }
        }

        // 删除记录
        async function deleteRecord(id) {
            if (!currentUser) return;
            if (!confirm('确定要删除这条记录吗？')) return;
            
            try {
                showLoader(true, "正在删除...");
                
                if (isOnline) {
                    await database.ref(`users/${currentUser.uid}/records/${id}`).remove();
                } else {
                    const pendingChanges = JSON.parse(localStorage.getItem('pendingChanges')) || [];
                    pendingChanges.push({
                        type: 'delete',
                        id: id
                    });
                    localStorage.setItem('pendingChanges', JSON.stringify(pendingChanges));
                }
                
                records = records.filter(record => record.id !== id);
                
                updateUI();
                updateDetailsCharts();
            } catch (error) {
                console.error("删除失败:", error);
                alert('删除失败，请检查网络连接');
            } finally {
                showLoader(false);
            }
        }

        // 初始化图表
        function initCharts() {
            if (profitChart) profitChart.destroy();
            if (incomeChart) incomeChart.destroy();
            if (expenseChart) expenseChart.destroy();

            const chartConfig = {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            };

            profitChart = new Chart(document.getElementById('profitChart'), {
                ...chartConfig,
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        borderColor: '#007AFF',
                        backgroundColor: 'rgba(0,122,255,0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                }
            });

            incomeChart = new Chart(document.getElementById('incomeChart'), {
                ...chartConfig,
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        borderColor: '#34C759',
                        backgroundColor: 'rgba(52,199,89,0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                }
            });

            expenseChart = new Chart(document.getElementById('expenseChart'), {
                ...chartConfig,
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        borderColor: '#FF3B30',
                        backgroundColor: 'rgba(255,59,48,0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                }
            });
        }

        // 更新详细数据图表
        function updateDetailsCharts() {
            const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

            // 确保图表已初始化
            if (!profitChart || !incomeChart || !expenseChart) {
                initCharts();
            }

            let filteredRecords = records;
            if (startDate || endDate) {
                filteredRecords = records.filter(record => {
                    const recordDate = new Date(record.date);
                    return (!startDate || recordDate >= startDate) && (!endDate || recordDate <= endDate);
                });
            }

            // 获取最近7天的数据
            const last7Days = Array.from({length: 7}, (_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - i);
                return date.toISOString().split('T')[0];
            }).reverse();

            const dailyData = {};
            last7Days.forEach(date => {
                dailyData[date] = {
                    income: 0,
                    expense: 0,
                    profit: 0
                };
            });

            // 处理记录并填充数据
            filteredRecords.forEach(record => {
                // 确保日期存在于数据结构中
                if (!dailyData[record.date] && last7Days.includes(record.date)) {
                    dailyData[record.date] = { income: 0, expense: 0, profit: 0 };
                }
                
                if (dailyData[record.date]) {
                    if (record.type.startsWith('收入')) {
                        dailyData[record.date].income += record.amount;
                        dailyData[record.date].profit += record.amount;
                    } else {
                        dailyData[record.date].expense += record.amount;
                        dailyData[record.date].profit -= record.amount;
                    }
                }
            });

            // 更新图表数据
            profitChart.data.labels = last7Days.map(date => formatDate(date));
            profitChart.data.datasets[0].data = last7Days.map(date => dailyData[date].profit);

            incomeChart.data.labels = last7Days.map(date => formatDate(date));
            incomeChart.data.datasets[0].data = last7Days.map(date => dailyData[date].income);

            expenseChart.data.labels = last7Days.map(date => formatDate(date));
            expenseChart.data.datasets[0].data = last7Days.map(date => dailyData[date].expense);

            // 计算并更新总数据 - 使用所有过滤后的记录，不只是近7天
            const totals = filteredRecords.reduce((acc, record) => {
                if (record.type.startsWith('收入')) {
                    acc.income += record.amount;
                    acc.profit += record.amount;
                } else if (record.type.startsWith('费用')) {
                    acc.expense += record.amount;
                    acc.profit -= record.amount;
                }
                return acc;
            }, { income: 0, expense: 0, profit: 0 });

            // 更新DOM上的总计数据
            document.getElementById('totalIncome').textContent = totals.income.toFixed(2);
            document.getElementById('totalExpense').textContent = totals.expense.toFixed(2);
            document.getElementById('totalProfit').textContent = totals.profit.toFixed(2);

            // 更新图表
            profitChart.update();
            incomeChart.update();
            expenseChart.update();
        }

        // 主界面导出为CSV
        function exportToCsv() {
            const recordsToExport = selectedDate ? 
                records.filter(record => record.date === selectedDate) : 
                records;
            
            if (recordsToExport.length === 0) {
                alert('没有可导出的记录');
                return;
            }
            
            let csv = '日期,类型,金额\n';
            recordsToExport.forEach(record => {
                csv += `${record.date},${record.type},${record.amount.toFixed(2)}\n`;
            });
            
            exportFile(csv, 'csv', `记账数据${selectedDate ? `_${selectedDate}` : ''}_${new Date().toLocaleDateString()}`);
        }

        // 主界面导出为Excel
        function exportToExcel() {
            const recordsToExport = selectedDate ? 
                records.filter(record => record.date === selectedDate) : 
                records;
            
            if (recordsToExport.length === 0) {
                alert('没有可导出的记录');
                return;
            }
            
            const data = [
                ['日期', '类型', '金额'],
                ...recordsToExport.map(record => [record.date, record.type, record.amount.toFixed(2)])
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "记账数据");
            XLSX.writeFile(wb, `记账数据${selectedDate ? `_${selectedDate}` : ''}_${new Date().toLocaleDateString()}.xlsx`);
        }

        // 详细数据导出为CSV
        function exportDetailsToCsv() {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            const recordsToExport = getFilteredRecords(startDate, endDate);
            
            if (recordsToExport.length === 0) {
                alert('指定范围内没有记录');
                return;
            }
            
            let csv = '日期,类型,金额\n';
            recordsToExport.forEach(record => {
                csv += `${record.date},${record.type},${record.amount.toFixed(2)}\n`;
            });
            
            exportFile(csv, 'csv', `详细记账数据_${startDate || '开始'}_至_${endDate || '现在'}_${new Date().toLocaleDateString()}`);
        }

        // 详细数据导出为Excel
        function exportDetailsToExcel() {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            const recordsToExport = getFilteredRecords(startDate, endDate);
            
            if (recordsToExport.length === 0) {
                alert('指定范围内没有记录');
                return;
            }
            
            const data = [
                ['日期', '类型', '金额'],
                ...recordsToExport.map(record => [record.date, record.type, record.amount.toFixed(2)])
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "详细记账数据");
            XLSX.writeFile(wb, `详细记账数据_${startDate || '开始'}_至_${endDate || '现在'}_${new Date().toLocaleDateString()}.xlsx`);
        }

        // 获取过滤后的记录
        function getFilteredRecords(startDate, endDate) {
            let filteredRecords = records;
            if (startDate || endDate) {
                filteredRecords = records.filter(record => {
                    const recordDate = new Date(record.date);
                    return (!startDate || recordDate >= new Date(startDate)) && (!endDate || recordDate <= new Date(endDate));
                });
            }
            return filteredRecords;
        }

        // 导出文件通用函数
        function exportFile(content, type, filename) {
            const blob = new Blob([content], { type: `text/${type};charset=utf-8;` });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${filename}.${type}`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // 全局函数
        window.deleteRecord = deleteRecord;

        // 添加自动登录功能
        async function checkAutoLogin() {
            const savedEmail = localStorage.getItem('userEmail');
            const savedPassword = localStorage.getItem('userPassword');
            
            if (savedEmail && savedPassword) {
                emailInput.value = savedEmail;
                passwordInput.value = savedPassword;
                
                try {
                    // 使用 Promise.race 设置超时
                    await Promise.race([
                        auth.signInWithEmailAndPassword(savedEmail, savedPassword),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('登录超时')), 5000)
                        )
                    ]);
                } catch (error) {
                    console.error("自动登录失败:", error);
                    // 清除可能过期的登录信息
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('userPassword');
                }
            }
        }

        // 新增日期导航功能
        function navigateDate(days) {
            const currentDate = new Date(selectedDate);
            currentDate.setDate(currentDate.getDate() + days);
            selectedDate = currentDate.toISOString().split('T')[0];
            datePicker.value = selectedDate;
            dateDisplay.textContent = formatDate(selectedDate);
            updateUI();
        }

        // 启动应用
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
