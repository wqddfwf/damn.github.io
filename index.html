<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <!-- PWA 必需标签 -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007AFF">

  <!-- iOS 额外支持 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="记账">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon.png">

  <!-- 安卓/通用 PWA 支持 -->
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- 添加Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  
  <!-- 添加SheetJS库用于Excel导出 -->
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  
  <!-- 添加Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600&display=swap" rel="stylesheet">
  
  <title>每日记账</title>
  <style>
      :root {
          --primary-blue: #007AFF;
          --primary-red: #FF3B30;
          --primary-green: #34C759;
          --primary-orange: #FF9500;
          --system-gray-1: #F2F2F7;
          --system-gray-2: #E5E5EA;
          --system-gray-3: #D1D1D6;
          --system-gray-4: #8E8E93;
          --system-gray-5: #636366;
          --system-gray-6: #48484A;
          --white: #FFFFFF;
          --black: #000000;
      }
      
      body {
          font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
          background-color: var(--system-gray-1);
          color: var(--black);
          margin: 0;
          padding: 0;
          max-width: 100%;
          overflow-x: hidden;
          -webkit-tap-highlight-color: transparent;
          line-height: 1.5;
          padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      }
      
      .container {
          padding: 20px;
          max-width: 600px;
          margin: 0 auto;
          padding-bottom: 100px;
      }
      
      .header {
          font-size: 28px;
          font-weight: 600;
          margin-bottom: 24px;
          text-align: center;
          color: var(--black);
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      
      .logout-button {
          background: none;
          border: none;
          cursor: pointer;
          padding: 8px;
          display: flex;
          align-items: center;
      }
      
      .logout-button:hover {
          background-color: var(--system-gray-2);
          border-radius: 50%;
      }

      /* 简化的登录界面 */
      .auth-card {
          background-color: var(--white);
          border-radius: 12px;
          padding: 24px;
          margin: 40px 20px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.08);
          max-width: 400px;
          margin-left: auto;
          margin-right: auto;
      }
      
      .auth-title {
          font-size: 22px;
          font-weight: 600;
          margin-bottom: 24px;
          text-align: center;
          color: var(--black);
      }
      
      .auth-form {
          display: flex;
          flex-direction: column;
          gap: 16px;
      }
      
      .auth-input {
          padding: 14px;
          border: 1px solid var(--system-gray-2);
          border-radius: 8px;
          font-size: 16px;
          background-color: var(--system-gray-1);
          transition: border-color 0.2s;
          width: 100%;
          box-sizing: border-box;
      }
      
      .auth-input:focus {
          outline: none;
          border-color: var(--primary-blue);
      }
      
      .auth-button {
          padding: 14px;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 500;
          cursor: pointer;
          border: none;
          transition: all 0.2s;
          width: 100%;
      }
      
      .login-button {
          background-color: var(--primary-blue);
          color: var(--white);
          margin-top: 8px;
      }
      
      .login-button:hover {
          background-color: #0066CC;
      }
      
      .forgot-password {
          color: var(--primary-blue);
          font-size: 14px;
          text-align: center;
          margin-top: 12px;
          cursor: pointer;
      }
      
      /* 主应用内容 */
      .date-picker {
          margin-bottom: 20px;
          background-color: var(--white);
          padding: 16px;
          border-radius: 12px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.08);
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      
      .date-picker-button {
          background: none;
          border: none;
          padding: 8px;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 16px;
          color: var(--primary-blue);
      }
      
      .date-picker-button:hover {
          background-color: var(--system-gray-2);
          border-radius: 8px;
      }
      
      .hidden-date-input {
          display: none;
      }
      
      .summary-card {
          background-color: var(--white);
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 20px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      }
      
      .summary-title {
          font-size: 17px;
          color: var(--system-gray-4);
          margin-bottom: 16px;
          text-align: center;
          font-weight: 500;
      }
      
      .summary-items {
          display: flex;
          justify-content: space-between;
          gap: 12px;
      }
      
      .summary-item {
          flex: 1;
          text-align: center;
          padding: 12px;
          border-radius: 8px;
          background-color: var(--system-gray-1);
      }
      
      .summary-item-title {
          font-size: 14px;
          color: var(--system-gray-4);
          margin-bottom: 6px;
      }
      
      .summary-item-value {
          font-size: 20px;
          font-weight: 600;
      }
      
      .records-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 12px;
      }
      
      .records-title {
          font-size: 17px;
          color: var(--system-gray-4);
          font-weight: 500;
      }
      
      .export-dropdown {
          position: relative;
          display: inline-block;
      }
      
      .export-button {
          padding: 8px 16px;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
          border: 1px solid var(--system-gray-2);
          background-color: var(--white);
          color: var(--primary-blue);
          transition: all 0.2s;
          display: flex;
          align-items: center;
          gap: 6px;
      }
      
      .export-button:hover {
          background-color: var(--system-gray-1);
      }
      
      .dropdown-content {
          display: none;
          position: absolute;
          right: 0;
          background-color: var(--white);
          min-width: 120px;
          box-shadow: 0 8px 16px rgba(0,0,0,0.1);
          border-radius: 8px;
          z-index: 1;
          overflow: hidden;
      }
      
      .dropdown-content a {
          color: var(--system-gray-6);
          padding: 12px 16px;
          text-decoration: none;
          display: block;
          font-size: 14px;
          transition: background-color 0.2s;
      }
      
      .dropdown-content a:hover {
          background-color: var(--system-gray-1);
      }
      
      .export-dropdown:hover .dropdown-content {
          display: block;
      }
      
      .records-list {
          background-color: var(--white);
          border-radius: 12px;
          overflow: hidden;
          margin-bottom: 20px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      }
      
      .record-item {
          padding: 16px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-bottom: 1px solid var(--system-gray-1);
      }
      
      .record-item:last-child {
          border-bottom: none;
      }
      
      .record-type {
          font-size: 16px;
          flex: 1;
      }
      
      .record-amount.income {
          color: var(--primary-green);
          font-weight: 500;
      }
      
      .record-amount.expense {
          color: var(--primary-red);
          font-weight: 500;
      }
      
      .no-records {
          text-align: center;
          color: var(--system-gray-4);
          padding: 24px;
          font-size: 16px;
      }
      
      /* 优化的添加按钮 */
      .add-button {
          position: fixed;
          bottom: calc(24px + env(safe-area-inset-bottom));
          right: 24px;
          width: 60px;
          height: 60px;
          background: linear-gradient(135deg, var(--primary-blue), #0066CC);
          color: var(--white);
          border-radius: 30px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 28px;
          box-shadow: 0 4px 12px rgba(0,122,255,0.3);
          border: none;
          cursor: pointer;
          z-index: 10;
          transition: all 0.2s;
      }
      
      .add-button:hover {
          transform: scale(1.05);
          box-shadow: 0 6px 16px rgba(0,122,255,0.4);
      }
      
      /* 模态框样式 */
      .modal {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: rgba(0,0,0,0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 100;
          display: none;
          padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      }
      
      .modal-content {
          background-color: var(--white);
          width: calc(100% - 40px);
          max-width: 400px;
          border-radius: 12px;
          overflow: hidden;
          animation: modal-appear 0.3s ease-out;
          margin: auto;
      }
      
      @keyframes modal-appear {
          from { transform: scale(0.95); opacity: 0; }
          to { transform: scale(1); opacity: 1; }
      }
      
      .modal-header {
          padding: 16px;
          font-size: 20px;
          font-weight: 600;
          border-bottom: 1px solid var(--system-gray-1);
      }
      
      .modal-body {
          padding: 16px;
      }
      
      .form-group {
          margin-bottom: 16px;
      }
      
      .form-group label {
          display: block;
          margin-bottom: 8px;
          color: var(--system-gray-5);
          font-size: 15px;
          font-weight: 500;
      }
      
      .form-group input {
          width: 100%;
          padding: 12px;
          border: 1px solid var(--system-gray-2);
          border-radius: 8px;
          font-size: 16px;
          background-color: var(--system-gray-1);
      }
      
      .type-options {
          display: flex;
          flex-wrap: wrap;
          gap: 8px;
      }
      
      .type-option {
          padding: 8px 16px;
          border: 1px solid var(--system-gray-2);
          border-radius: 8px;
          font-size: 14px;
          cursor: pointer;
          background-color: var(--system-gray-1);
          transition: all 0.2s;
      }
      
      .type-option.selected {
          background-color: var(--primary-blue);
          color: var(--white);
          border-color: var(--primary-blue);
      }
      
      .type-option:hover {
          background-color: var(--system-gray-2);
      }
      
      .modal-footer {
          display: flex;
          justify-content: flex-end;
          padding: 16px;
          border-top: 1px solid var(--system-gray-1);
          gap: 8px;
      }
      
      .btn {
          padding: 10px 16px;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.2s;
      }
      
      .btn-cancel {
          background-color: transparent;
          color: var(--system-gray-5);
      }
      
      .btn-cancel:hover {
          background-color: var(--system-gray-1);
      }
      
      .btn-save {
          background-color: var(--primary-blue);
          color: var(--white);
          border: none;
      }
      
      .btn-save:hover {
          background-color: #0066CC;
      }
      
      .delete-btn {
          color: var(--primary-red);
          background: none;
          border: none;
          padding: 8px;
          cursor: pointer;
          font-size: 16px;
          border-radius: 6px;
          transition: all 0.2s;
      }
      
      .delete-btn:hover {
          background-color: rgba(255,59,48,0.1);
      }

      /* 针对iOS PWA的优化 */
      @supports (-webkit-touch-callout: none) {
          body {
              overscroll-behavior-y: contain;
          }
      }
      
      /* 加载指示器 */
      .loader {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: rgba(0,0,0,0.5);
          z-index: 1000;
          justify-content: center;
          align-items: center;
          padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      }
      
      .loader-content {
          background-color: var(--white);
          padding: 24px;
          border-radius: 12px;
          text-align: center;
          max-width: 80%;
      }
      
      .loader-spinner {
          width: 40px;
          height: 40px;
          border: 4px solid var(--system-gray-2);
          border-top-color: var(--primary-blue);
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin: 0 auto 16px;
      }
      
      @keyframes spin {
          to { transform: rotate(360deg); }
      }
      
      .loader-text {
          font-size: 16px;
          color: var(--system-gray-5);
      }
      
      /* 离线提示 */
      .offline-notice {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background-color: var(--primary-orange);
          color: var(--white);
          padding: 12px;
          text-align: center;
          font-size: 14px;
          z-index: 5;
          transform: translateY(100%);
          transition: transform 0.3s ease-out;
          padding-bottom: calc(12px + env(safe-area-inset-bottom));
      }
      
      .offline-notice.show {
          transform: translateY(0);
      }
      
      /* 密码重置模态框 */
      .reset-modal-content {
          background-color: var(--white);
          width: calc(100% - 40px);
          max-width: 400px;
          border-radius: 12px;
          overflow: hidden;
          margin: auto;
      }
      
      .reset-instructions {
          font-size: 14px;
          color: var(--system-gray-4);
          margin-top: 8px;
      }
      
      /* 响应式调整 */
      @media (max-width: 400px) {
          .summary-items {
              flex-direction: column;
              gap: 12px;
          }
      }
  </style>
</head>
<body>
    <!-- 加载指示器 -->
    <div class="loader" id="loader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <p class="loader-text" id="loaderText">数据加载中...</p>
        </div>
    </div>
    
    <!-- 离线提示 -->
    <div class="offline-notice" id="offlineNotice">
        您当前处于离线状态，可以查看最近数据
    </div>
    
    <div class="container">
        <!-- 认证部分 -->
        <div id="authSection">
            <div class="auth-card">
                <h2 class="auth-title">每日记账</h2>
                <div id="loginForm" class="auth-form">
                    <input type="email" id="email" class="auth-input" placeholder="电子邮箱">
                    <input type="password" id="password" class="auth-input" placeholder="密码">
                    <button id="loginButton" class="auth-button login-button">登录</button>
                    <div class="forgot-password" id="forgotPassword">忘记密码？</div>
                    <div id="authError" class="error-message" style="color: var(--primary-red); text-align: center; font-size: 14px;"></div>
                </div>
            </div>
        </div>
        
        <!-- 主应用内容 (默认隐藏，登录后显示) -->
        <div id="appContent" style="display: none;">
            <div class="header">
                <span>每日记账</span>
                <button class="logout-button" id="logoutButton" title="退出登录">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9M16 17L21 12M21 12L16 7M21 12H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            
            <div class="date-picker">
                <span id="dateDisplay"></span>
                <button class="date-picker-button" id="datePickerButton">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 10H4M16 2V6M8 2V6M3 6H21V20C21 20.5523 20.5523 21 20 21H4C3.44772 21 3 20.5523 3 20V6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    选择日期
                </button>
                <input type="date" id="datePicker" class="hidden-date-input">
            </div>
            
            <div class="summary-card">
                <div class="summary-title">概览</div>
                <div class="summary-items">
                    <div class="summary-item">
                        <div class="summary-item-title">收入</div>
                        <div class="summary-item-value" id="incomeTotal">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-item-title">费用</div>
                        <div class="summary-item-value" id="expenseTotal">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-item-title">利润</div>
                        <div class="summary-item-value" id="profitTotal">0.00</div>
                    </div>
                </div>
            </div>
            
            <div class="records-header">
                <div class="records-title">记录</div>
                <div class="export-dropdown">
                    <button class="export-button">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 3V16M12 16L16 12M12 16L8 12M6 20H18C19.1046 20 20 19.1046 20 18V6C20 4.89543 19.1046 4 18 4H6C4.89543 4 4 4.89543 4 6V18C4 19.1046 4.89543 20 6 20Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        导出
                    </button>
                    <div class="dropdown-content">
                        <a href="#" id="exportCsv">导出为CSV</a>
                        <a href="#" id="exportExcel">导出为Excel</a>
                    </div>
                </div>
            </div>
            <div class="records-list" id="recordsList">
                <div class="no-records">暂无记录</div>
            </div>
            
            <button class="add-button" id="addButton">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 6V12M12 12V18M12 12H18M12 12H6" stroke="white" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            
            <!-- 添加记录模态框 -->
            <div class="modal" id="addModal">
                <div class="modal-content">
                    <div class="modal-header">添加记录</div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="amount">金额</label>
                            <input type="number" id="amount" placeholder="输入金额">
                        </div>
                        <div class="form-group">
                            <label>类型</label>
                            <div class="type-options" id="typeOptions">
                                <div class="type-option" data-type="收入-吃喝岭师">收入-吃喝岭师</div>
                                <div class="type-option" data-type="收入-24个半">收入-24个半</div>
                                <div class="type-option" data-type="费用-食材">费用-食材</div>
                                <div class="type-option" data-type="费用-交通">费用-交通</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-cancel" id="cancelBtn">取消</button>
                        <button class="btn btn-save" id="saveBtn">保存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 密码重置模态框 -->
    <div class="modal" id="resetModal">
        <div class="reset-modal-content">
            <div class="modal-header">重置密码</div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="resetEmail">电子邮箱</label>
                    <input type="email" id="resetEmail" placeholder="输入您的注册邮箱">
                    <p class="reset-instructions">我们将发送密码重置链接到您的邮箱</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" id="resetCancelBtn">取消</button>
                <button class="btn btn-save" id="resetSubmitBtn">发送</button>
            </div>
        </div>
    </div>

    <script>
        // 数据结构
        class Record {
            constructor(amount, type, date) {
                this.id = Date.now().toString();
                this.amount = parseFloat(amount);
                this.type = type;
                this.date = date;
            }
        }

        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDYY_Cex21vcQGR9beUvOniHxNeRqbpr6k",
            authDomain: "jizhang-e867a.firebaseapp.com",
            databaseURL: "https://jizhang-e867a-default-rtdb.firebaseio.com",
            projectId: "jizhang-e867a",
            storageBucket: "jizhang-e867a.appspot.com",
            messagingSenderId: "879272417495",
            appId: "1:879272417495:web:11ff018db63c50c3ccf892",
            measurementId: "G-4R1MKP7G6S"
        };

        // 初始化Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // 启用离线持久化
        database.goOnline();
        
        // 应用状态
        let records = [];
        let selectedDate = new Date().toISOString().split('T')[0];
        let currentUser = null;
        let isOnline = navigator.onLine;
        let selectedType = null;

        // DOM元素
        const datePicker = document.getElementById('datePicker');
        const datePickerButton = document.getElementById('datePickerButton');
        const dateDisplay = document.getElementById('dateDisplay');
        const incomeTotal = document.getElementById('incomeTotal');
        const expenseTotal = document.getElementById('expenseTotal');
        const profitTotal = document.getElementById('profitTotal');
        const recordsList = document.getElementById('recordsList');
        const addButton = document.getElementById('addButton');
        const addModal = document.getElementById('addModal');
        const amountInput = document.getElementById('amount');
        const typeOptions = document.getElementById('typeOptions');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveBtn = document.getElementById('saveBtn');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        const authSection = document.getElementById('authSection');
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authError = document.getElementById('authError');
        const appContent = document.getElementById('appContent');
        const exportCsvBtn = document.getElementById('exportCsv');
        const exportExcelBtn = document.getElementById('exportExcel');
        const forgotPassword = document.getElementById('forgotPassword');
        const resetModal = document.getElementById('resetModal');
        const resetEmail = document.getElementById('resetEmail');
        const resetCancelBtn = document.getElementById('resetCancelBtn');
        const resetSubmitBtn = document.getElementById('resetSubmitBtn');
        const offlineNotice = document.getElementById('offlineNotice');
        const logoutButton = document.getElementById('logoutButton');

        // 显示/隐藏加载指示器
        function showLoader(show, text = "数据加载中...") {
            loaderText.textContent = text;
            loader.style.display = show ? 'flex' : 'none';
        }

        // 更新网络状态
        function updateNetworkStatus() {
            isOnline = navigator.onLine;
            if (isOnline) {
                offlineNotice.classList.remove('show');
                if (currentUser) {
                    syncPendingChanges();
                }
            } else {
                offlineNotice.classList.add('show');
            }
        }

        // 同步离线时的更改
        async function syncPendingChanges() {
            const pendingChanges = JSON.parse(localStorage.getItem('pendingChanges')) || [];
            if (pendingChanges.length === 0) return;
            
            showLoader(true, "正在同步离线更改...");
            
            try {
                for (const change of pendingChanges) {
                    if (change.type === 'add') {
                        await database.ref(`users/${currentUser.uid}/records/${change.data.id}`).set(change.data);
                    } else if (change.type === 'delete') {
                        await database.ref(`users/${currentUser.uid}/records/${change.id}`).remove();
                    }
                }
                
                localStorage.removeItem('pendingChanges');
                await loadRecordsFromFirebase();
                updateUI();
            } catch (error) {
                console.error("同步失败:", error);
            } finally {
                showLoader(false);
            }
        }

        // 初始化
        async function init() {
            showLoader(true);
            datePicker.value = selectedDate;
            dateDisplay.textContent = formatDate(selectedDate);
            
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
            updateNetworkStatus();
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    loginForm.style.display = 'none';
                    authSection.style.display = 'none';
                    appContent.style.display = 'block';
                    
                    try {
                        await loadRecordsFromFirebase();
                        updateUI();
                    } catch (error) {
                        console.error("加载数据失败:", error);
                        authError.textContent = "加载数据失败，请重试";
                    }
                } else {
                    currentUser = null;
                    loginForm.style.display = 'block';
                    authSection.style.display = 'block';
                    appContent.style.display = 'none';
                    records = [];
                }
                showLoader(false);
            });
            
            datePickerButton.addEventListener('click', () => {
                datePicker.click();
            });
            
            datePicker.addEventListener('change', (e) => {
                selectedDate = e.target.value;
                dateDisplay.textContent = formatDate(selectedDate);
                updateUI();
            });
            
            addButton.addEventListener('click', () => {
                if (!currentUser) return;
                addModal.style.display = 'flex';
                amountInput.focus();
                selectedType = null;
                updateTypeSelection();
            });
            
            cancelBtn.addEventListener('click', () => {
                addModal.style.display = 'none';
                amountInput.value = '';
                selectedType = null;
            });
            
            saveBtn.addEventListener('click', saveRecord);
            
            loginButton.addEventListener('click', handleLogin);
            
            logoutButton.addEventListener('click', handleLogout);
            
            exportCsvBtn.addEventListener('click', exportToCsv);
            exportExcelBtn.addEventListener('click', exportToExcel);
            
            forgotPassword.addEventListener('click', () => {
                resetModal.style.display = 'flex';
                resetEmail.value = emailInput.value || '';
                resetEmail.focus();
            });
            
            resetCancelBtn.addEventListener('click', () => {
                resetModal.style.display = 'none';
                resetEmail.value = '';
            });
            
            resetSubmitBtn.addEventListener('click', handlePasswordReset);
            
            typeOptions.addEventListener('click', (e) => {
                const option = e.target.closest('.type-option');
                if (option) {
                    selectedType = option.dataset.type;
                    updateTypeSelection();
                }
            });
            
            addModal.addEventListener('click', (e) => {
                if (e.target === addModal) {
                    addModal.style.display = 'none';
                    amountInput.value = '';
                    selectedType = null;
                }
            });
            
            resetModal.addEventListener('click', (e) => {
                if (e.target === resetModal) {
                    resetModal.style.display = 'none';
                    resetEmail.value = '';
                }
            });

            amountInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveRecord();
                }
            });
            
            resetEmail.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handlePasswordReset();
                }
            });

            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
                document.body.classList.add('standalone');
            }
        }

        // 格式化日期显示
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // 更新类型选择状态
        function updateTypeSelection() {
            const options = typeOptions.querySelectorAll('.type-option');
            options.forEach(option => {
                if (option.dataset.type === selectedType) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        // 处理退出登录
        async function handleLogout() {
            try {
                showLoader(true, "正在退出...");
                await auth.signOut();
            } catch (error) {
                console.error("退出失败:", error);
                authError.textContent = "退出失败，请重试";
            } finally {
                showLoader(false);
            }
        }

        // 处理登录/注册
        async function handleLogin() {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!email || !password) {
                authError.textContent = "请输入邮箱和密码";
                return;
            }
            
            showLoader(true, "正在登录...");
            authError.textContent = "";
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (loginError) {
                console.error("登录错误:", loginError);
                
                if (loginError.code === 'auth/user-not-found') {
                    try {
                        await auth.createUserWithEmailAndPassword(email, password);
                        authError.textContent = "注册成功，已自动登录";
                    } catch (signupError) {
                        console.error("注册错误:", signupError);
                        authError.textContent = getAuthErrorMessage(signupError);
                    }
                } else {
                    authError.textContent = getAuthErrorMessage(loginError);
                }
            } finally {
                showLoader(false);
            }
        }

        // 处理密码重置
        async function handlePasswordReset() {
            const email = resetEmail.value.trim();
            
            if (!email) {
                authError.textContent = "请输入注册邮箱";
                return;
            }
            
            showLoader(true, "正在发送重置邮件...");
            
            try {
                await auth.sendPasswordResetEmail(email);
                resetModal.style.display = 'none';
                resetEmail.value = '';
                authError.textContent = "密码重置邮件已发送，请检查您的邮箱";
            } catch (error) {
                console.error("密码重置错误:", error);
                authError.textContent = getAuthErrorMessage(error);
            } finally {
                showLoader(false);
            }
        }

        // 获取认证错误信息
        function getAuthErrorMessage(error) {
            const errorMap = {
                'auth/invalid-email': '邮箱格式不正确，请检查',
                'auth/user-disabled': '账户已被禁用，请联系管理员',
                'auth/user-not-found': '账户不存在，将尝试注册',
                'auth/wrong-password': '密码错误，请重试',
                'auth/email-already-in-use': '邮箱已被注册，请直接登录',
                'auth/weak-password': '密码强度不足(至少6个字符)',
                'auth/operation-not-allowed': '未启用邮箱/密码登录，请检查Firebase配置',
                'auth/too-many-requests': '尝试次数过多，请稍后再试',
                'auth/network-request-failed': '网络连接失败，请检查网络',
                'auth/missing-email': '请输入邮箱地址'
            };
            
            return errorMap[error.code] || `操作失败: ${error.message}`;
        }

        // 从Firebase加载数据
        async function loadRecordsFromFirebase() {
            if (!currentUser) return;
            
            return new Promise((resolve, reject) => {
                database.ref(`users/${currentUser.uid}/records`).once('value')
                    .then((snapshot) => {
                        const data = snapshot.val();
                        records = data ? Object.values(data) : [];
                        records.sort((a, b) => new Date(b.date) - new Date(a.date));
                        resolve();
                    })
                    .catch((error) => {
                        reject(error);
                    });
            });
        }

        // 更新UI
        function updateUI() {
            const filteredRecords = records.filter(record => record.date === selectedDate);
            
            const dailyIncome = filteredRecords
                .filter(record => record.type.startsWith('收入'))
                .reduce((sum, record) => sum + record.amount, 0);
                
            const dailyExpense = filteredRecords
                .filter(record => record.type.startsWith('费用'))
                .reduce((sum, record) => sum + record.amount, 0);
                
            const dailyProfit = dailyIncome - dailyExpense;
            
            incomeTotal.textContent = dailyIncome.toFixed(2);
            expenseTotal.textContent = dailyExpense.toFixed(2);
            profitTotal.textContent = dailyProfit.toFixed(2);
            
            profitTotal.style.color = dailyProfit >= 0 ? 'var(--primary-green)' : 'var(--primary-red)';
            
            renderRecords(filteredRecords);
        }

        // 渲染记录列表
        function renderRecords(recordsToRender) {
            if (recordsToRender.length === 0) {
                recordsList.innerHTML = '<div class="no-records">暂无记录</div>';
                return;
            }
            
            let html = '';
            recordsToRender.forEach(record => {
                const isIncome = record.type.startsWith('收入');
                html += `
                    <div class="record-item" data-id="${record.id}">
                        <span class="record-type">${record.type}</span>
                        <span class="record-amount ${isIncome ? 'income' : 'expense'}">${record.amount.toFixed(2)}</span>
                        <button class="delete-btn" onclick="deleteRecord('${record.id}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                `;
            });
            
            recordsList.innerHTML = html;
        }

        // 保存记录
        async function saveRecord() {
            if (!currentUser) return;
            
            const amount = amountInput.value.trim();
            
            if (!amount || isNaN(amount)) {
                alert('请输入有效的金额');
                return;
            }
            
            if (!selectedType) {
                alert('请选择记录类型');
                return;
            }
            
            const newRecord = new Record(amount, selectedType, selectedDate);
            
            try {
                showLoader(true, "正在保存...");
                
                if (isOnline) {
                    await database.ref(`users/${currentUser.uid}/records/${newRecord.id}`).set(newRecord);
                } else {
                    const pendingChanges = JSON.parse(localStorage.getItem('pendingChanges')) || [];
                    pendingChanges.push({
                        type: 'add',
                        data: newRecord
                    });
                    localStorage.setItem('pendingChanges', JSON.stringify(pendingChanges));
                }
                
                records.push(newRecord);
                
                amountInput.value = '';
                selectedType = null;
                addModal.style.display = 'none';
                updateUI();
            } catch (error) {
                console.error("保存失败:", error);
                alert('保存失败，请检查网络连接');
            } finally {
                showLoader(false);
            }
        }

        // 删除记录
        async function deleteRecord(id) {
            if (!currentUser) return;
            if (!confirm('确定要删除这条记录吗？')) return;
            
            try {
                showLoader(true, "正在删除...");
                
                if (isOnline) {
                    await database.ref(`users/${currentUser.uid}/records/${id}`).remove();
                } else {
                    const pendingChanges = JSON.parse(localStorage.getItem('pendingChanges')) || [];
                    pendingChanges.push({
                        type: 'delete',
                        id: id
                    });
                    localStorage.setItem('pendingChanges', JSON.stringify(pendingChanges));
                }
                
                records = records.filter(record => record.id !== id);
                
                updateUI();
            } catch (error) {
                console.error("删除失败:", error);
                alert('删除失败，请检查网络连接');
            } finally {
                showLoader(false);
            }
        }

        // 导出为CSV
        function exportToCsv() {
            if (records.length === 0) {
                alert('没有可导出的记录');
                return;
            }
            
            const recordsToExport = selectedDate ? 
                records.filter(record => record.date === selectedDate) : 
                records;
            
            if (recordsToExport.length === 0) {
                alert('选定日期没有记录');
                return;
            }
            
            let csv = '日期,类型,金额\n';
            recordsToExport.forEach(record => {
                csv += `${record.date},${record.type},${record.amount.toFixed(2)}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const dateSuffix = selectedDate ? `_${selectedDate}` : '';
            link.download = `记账数据${dateSuffix}_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }

        // 导出为Excel
        function exportToExcel() {
            if (records.length === 0) {
                alert('没有可导出的记录');
                return;
            }
            
            const recordsToExport = selectedDate ? 
                records.filter(record => record.date === selectedDate) : 
                records;
            
            if (recordsToExport.length === 0) {
                alert('选定日期没有记录');
                return;
            }
            
            const data = [
                ['日期', '类型', '金额'],
                ...recordsToExport.map(record => [
                    record.date,
                    record.type,
                    record.amount.toFixed(2)
                ])
            ];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "记账数据");
            
            const dateSuffix = selectedDate ? `_${selectedDate}` : '';
            XLSX.writeFile(wb, `记账数据${dateSuffix}_${new Date().toLocaleDateString()}.xlsx`);
        }

        // 全局函数
        window.deleteRecord = deleteRecord;

        // 启动应用
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
